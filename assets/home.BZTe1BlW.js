import"./pixel.CyAMObzi.js";import{v as ce,e as p,c as u,A as se,y as J,w as C,x as re,b as a,B as ue,C as me,u as pe,d as ye,D as fe,E as he}from"./scc.C0KxU-5h.js";import{M as b}from"./bootstrap.esm.BAnKzilB.js";import{J as be}from"./jszip.min.Dy8ZLiAd.js";import"https://webr.r-wasm.org/latest/webr.mjs";const S=document.getElementById("scc-one-modal");let O={},U=null,G=null;const Z="1.0.0",Ee=new URLSearchParams(window.location.search),Y=Ee.get("modelUID");let V={};const ne={DB_Icon:"fas fa-database"};let P;function Te(e,t){let d=e.replace(/\s/g,"_"),n=a("div","accordion-item border-light mb-0",null,a("h2","accordion-header",d+"_head",a("button","accordion-button collapsed",null,a("span","h6 mb-0 font-weight-bold",null,document.createTextNode(e)))));n.querySelector("button").setAttribute("type","button"),n.querySelector("button").setAttribute("data-bs-toggle","collapse"),n.querySelector("button").setAttribute("aria-expanded","false"),n.querySelector("button").setAttribute("data-bs-target","#"+d),n.querySelector("button").setAttribute("aria-controls",d);let l=a("div","accordion-collapse collapse",d,a("div","accordion-body",null,a("table","table table-hover",null,a("tbody",null,null,null))));l.setAttribute("aria-labelledby",d+"_head"),l.setAttribute("data-bs-parent","#tableGroup");for(let o of t){let i=a("tr",null,null,a("td",null,null,document.createTextNode(o[1])));i.onclick=function(){const c=document.getElementById("availableModal").querySelector("li.selectedValue");window.open(`./tableDisplay.html?tableName=${o[0]}&modelName=${c.innerText}`)},i.setAttribute("tableName",o[0]),l.querySelector("tbody").appendChild(i)}return n.appendChild(l),n}document.addEventListener("DOMContentLoaded",async function(){V=await ce();let e=await p("init");if(!e||e.msg!="Success"){u("Alert!","Some error occured while initializing sqlite.");return}if(Y){await se("/home/get-attached-model",{modelId:`${Y}`});const n=window.location.origin+window.location.pathname;history.replaceState(null,"",n)}setTimeout(ge,400);const t=document.getElementById("shareBtn");t.classList.add("blink"),document.querySelectorAll(".modal").forEach(n=>{b.getInstance(n)||new b(n)}),document.getElementById("modal-createView").addEventListener("hide.bs.modal",function(){document.getElementById("viewName").value="",document.getElementById("query-input").value=""}),document.getElementById("editorBtn").onclick=async function(){const n=document.getElementById("availableModal").querySelector("li.selectedValue").innerText;if(!n){u("Alert!","Please select a model");return}window.open(`./sqlEditor.html?tableName=V_TEMPV&modelName=${n}`)},document.getElementById("availInpFiles").onclick=function(){document.getElementById("modal-input-files").querySelector("h2").innerText="Input Files",K()},document.getElementById("availOutFiles").onclick=function(){document.getElementById("modal-input-files").querySelector("h2").innerText="Output Files",Fe()},document.getElementById("shareBtn").onclick=function(){const n=document.getElementById("availableModal").querySelector("li.selectedValue");if(!n){u("Alert!","Please select a model");return}const l=n.innerText,o=n.getAttribute("project");window.open(`./editorPage.html?projectName=${o}&modelName=${l}`)},document.getElementById("closeOutput").onclick=function(){document.getElementById("outputDiv").style.display="none"},document.getElementById("ok-view").onclick=Be,document.getElementById("deleteModel").onclick=te.bind(null,!0),document.getElementById("removeModel").onclick=te.bind(null,!1),document.getElementById("addNew").onclick=Ne.bind(null,"Add New Model",!1),document.getElementById("downloadAllFiles").onclick=qe,document.getElementById("addExisting").onclick=we,document.getElementById("saveAs").onclick=Ae,document.getElementById("uploadModel").onclick=Ie,document.getElementById("downloadModel").onclick=Se,document.getElementById("uploadExcel").onclick=ve,document.getElementById("downloadExcel").onclick=Ce,document.getElementById("vacuum").onclick=xe,document.getElementById("saveFiles").onclick=Le,document.getElementById("uploadPackage").onclick=Oe,document.getElementById("downloadOutput").onclick=Ue,await J("init","editor"),t.classList.remove("blink")});async function ge(){document.getElementById("tableGroup").innerHTML="";let e=await C("home","getUserModels");if(e.length==0){let t=await re(V);t.length>0&&e.push(t)}return _e(e),e}function _e(e){let t=document.getElementById("availableModal");t.innerHTML="";for(let d of e)t.appendChild(j(d));Y&&t.lastChild?t.lastChild.click():t.firstChild&&t.firstChild.click()}function j(e){let t=a("li","nav-item mb-0",null,null),d=a("a","nav-link p-2 rounded-0");return d.appendChild(a("span","d-block text-left",null,null)),d.firstChild.appendChild(a("span",`${ne.DB_Icon} pe-2`)),d.firstChild.appendChild(document.createTextNode(e[0])),t.appendChild(d),t.setAttribute("project",e[2]),t.setAttribute("template",e[1]),t.setAttribute("dbtype",e[3]),t.onclick=async function(n){if(t.getAttribute("project"),document.getElementById("outputTxt").innerHTML="",!this.classList.contains("selectedValue")){let c=await C("home","getVersion",{model_name:this.innerText});c!==Z&&await C("home","upgradeVersion",{modelName:this.innerText,db_version:c,current_version:Z});for(let s of this.parentNode.querySelectorAll("li.selectedValue"))s.classList.remove("selectedValue");W(this.innerText,e[1]),this.classList.add("selectedValue"),n.preventDefault()}const l=this.innerText;(await p("fetchData",l,"PRAGMA table_info(S_TaskMaster)")).map(c=>c[1]).includes("TaskType")||await p("executeQuery",l,"ALTER TABLE S_TaskMaster ADD COLUMN TaskType VARCHAR DEFAULT 'PythonScript'"),await p("executeQuery",l,`CREATE TABLE IF NOT EXISTS S_Notebooks (
                NotebookId	    INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
                Name            VARCHAR,
                Type			VARCHAR,
                Status	    	VARCHAR DEFAULT 'Active',
                CreationDate	VARCHAR DEFAULT (datetime('now','localtime')),
                LastUpdateDate	VARCHAR DEFAULT (datetime('now','localtime'))
            )`),await p("executeQuery",l,`CREATE TABLE IF NOT EXISTS S_NotebookContent (
                CellId	        INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
                Name            VARCHAR,
                NotebookId      INTEGER NOT NULL,    
                CellContent	    VARCHAR,
                CellType        VARCHAR,
                CreationDate	VARCHAR DEFAULT (datetime('now','localtime')),
                LastUpdateDate	VARCHAR DEFAULT (datetime('now','localtime'))
            )`),await p("executeQuery",l,`CREATE TABLE IF NOT EXISTS S_Queries (
                QueryId			INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
                Name	        VARCHAR UNIQUE,
                TableName       VARCHAR,
                ShowSummary     INTEGER NOT NULL,
                HideNullRows    INTEGER NOT NULL,
                Levels			VARCHAR DEFAULT '[]',
                Series          VARCHAR DEFAULT '[]',
                SeriesProperties     VARCHAR DEFAULT '{}',
                Layout	        VARCHAR DEFAULT '{}',
                GraphType       VARCHAR,
                WorksheetProperties  VARCHAR DEFAULT '{}',
                LevelsProperties	 VARCHAR DEFAULT '{}',
                CreationDate	VARCHAR DEFAULT (datetime('now','localtime')),
                LastUpdateDate	VARCHAR DEFAULT (datetime('now','localtime'))
            )`),await $(this.innerText)},t}async function W(e,t){document.getElementById("tableGroup").innerHTML="";const d=await C("home","fetchTableGroups",{model_name:e});for(let n in d)document.getElementById("tableGroup").appendChild(Te(n,d[n]))}function oe(e,t="fa-server",d=null){let n=a("ul","tree");for(let l in e){n.appendChild(document.createElement("li"));let o=ee(l,t);n.appendChild(o),o.onclick=function(){let i=o.nextElementSibling;if(o.firstChild.checked){o.firstChild.checked=!1;for(let c of i.childNodes)c.firstChild.checked&&(c.firstChild.checked=!1)}else{o.firstChild.checked=!0;for(let c of i.childNodes)c.firstChild.checked||(c.firstChild.checked=!0)}},n.appendChild(a("ul","childList TreeMembers"));for(let i of e[l]){let c=ee(i[0],ne.DB_Icon);d||(c.onclick=function(s){if(c.firstChild.checked)c.firstChild.checked=!1,o.firstChild.checked&&(o.firstChild.checked=!1);else{c.firstChild.checked=!0,o.firstChild.checked=!0;for(let r of this.parentNode.childNodes)r.firstChild.checked||(o.firstChild.checked=!1)}}),n.lastChild.appendChild(c)}}return a("div","card-body scc-box",null,n)}function ee(e,t){let d=a("li",null,null,a("input","inputcheckbox"));d.firstChild.setAttribute("type","checkbox");let n=a("label","checkBox-label",null,a("span",`fas ${t}`));return n.appendChild(document.createTextNode(e)),d.appendChild(n),d}function B(e,t){const d=S.querySelector(".modal-header h2");d.innerHTML="",d.innerText=e;const n=S.querySelector(".modal-body");n.innerHTML="";const l=S.querySelector(".modal-footer");l.innerHTML="";const o=a("button","btn btn-tertiary",null,document.createTextNode("Cancel"));o.setAttribute("type","button"),o.setAttribute("data-bs-dismiss","modal");const i=a("button","btn btn-primary ml-auto",null,document.createTextNode(t));return i.setAttribute("type","button"),l.appendChild(o),l.appendChild(i),[n,i]}function H(e,t,d,n,l=[],o="",i="",c="text"){let s;const r=a("div","row row-header align-items-center mb-4",e);let m=a("div","col-12 col-sm-4 align-self-center",null,a("label","my-2",null,document.createTextNode(t)));if(s=a("div","col-12 col-sm"),n=="select"){const f=a("select","form-select",d);(l.includes("Default")||l.length==0)&&f.appendChild(a("option",null,null,document.createTextNode("Default")));for(let y of l)if(y!="Default"){let h=a("option",null,null,document.createTextNode(y));f.appendChild(h)}f.firstChild&&(f.firstChild.setAttribute("selected",""),s.appendChild(f))}else{const f=a("div","input-group",null,a("input","form-control",d));f.firstChild.setAttribute("type",c),f.firstChild.setAttribute("placeholder",o),i.trim()!=""&&f.appendChild(a("span","input-group-text",null,a("span",i))),s.appendChild(f)}return r.appendChild(m),r.appendChild(s),r}function Ne(e,t=!1){const[d,n]=B(e,"Add"),l=a("div","form-group");l.appendChild(H("name_div","Model Name","db_name","normal",[],"","fas fa-database")),t?l.appendChild(H("path_div","Model Path","db_path","normal")):l.appendChild(H("template_div","Model Template","model_template","select",Object.keys(V))),d.appendChild(l),n.onclick=async function(o){const i=document.getElementById("db_name").value;if(i.trim()==""||!ae(i)){u("Alert!","Please enter valid model name");return}for(let h of document.getElementById("availableModal").querySelectorAll("li"))if(i.trim()==h.innerText){u("Alert!",`Model already active with same name ${i}`);return}let c=document.getElementById("model_template"),s="Sample DB";c&&(s=c.value);let r="Default";b.getInstance(S).hide();const y=await C("home","addNewModel",{model_name:i,model_template:s,project_name:r,schemas:V,db_user:"",password:"",host:"",port:0,db_type:"SQLITE"});if(y.msg==="Success"){let h=document.getElementById("availableModal");h.appendChild(j([i,s,r,"SQLITE"])),h.lastChild.click(),u("Success!","New Model added")}else u("Alert!",y.msg)}}async function we(){const[e,t]=B("Add Existing Models","Add"),d=new Object,n=await C("home","getExistingModels");let l=new Object;for(let o of n){let i=o[1],c=o[0];d[c]=[i,o[2],o[3]],i in l?l[i].push([c,o[2]]):l[i]=[[c,o[2]]]}e.appendChild(oe(l)),t.onclick=async function(){let o=[];for(let s of document.getElementById("availableModal").querySelectorAll("li"))o.push(s.innerText);let i={},c=[];for(let s of e.querySelectorAll(".TreeMembers li"))if(s.parentNode.classList.contains("childList")&&s.firstChild.checked){if(o.includes(s.innerText)){u("Alert!",`Model Already Active with name ${s.innerText}`);return}let r=s.parentNode.previousElementSibling.innerText;if(r in i||(i[r]=[]),i[r].push(s.innerText),c.includes(s.innerText)){u("Alert!","You Cannot Add more than one model of same name");return}c.push(s.innerText)}if(Object.keys(i).length>0){b.getInstance(S).hide(),await C("home","addExistingModels",{model_list:c,projects_dict:i});let r=document.getElementById("availableModal");for(let m of c)r.appendChild(j([m,d[m][1],d[m][0],d[m][2]]))}else b.getInstance(S).hide()}}function te(e){let t="Hide",d="Hide Models";e&&(t="Delete",d="Delete Models");const[n,l]=B(d,t);let o=new Object;for(let i of document.getElementById("availableModal").childNodes){let c=i.getAttribute("project"),s=i.getAttribute("template"),r=i.innerText;c in o?o[c].push([r,s]):o[c]=[[r,s]]}n.appendChild(oe(o)),l.onclick=async function(){let i=[],c={};for(let s of n.querySelectorAll(".TreeMembers li"))if(s.parentNode.classList.contains("childList")&&s.firstChild.checked){i.push(s.innerText);let r=s.parentNode.previousElementSibling.innerText;r in c||(c[r]=[]),c[r].push(s.innerText)}if(Object.keys(c).length>0){b.getInstance(S).hide(),await C("home","deleteModel",{projects_dict:c,del_opt:e});let r=document.getElementById("availableModal");for(let m of r.querySelectorAll("li"))i.indexOf(m.innerText)>-1&&m.remove();r.firstChild?r.firstChild.click():document.getElementById("tableGroup").innerHTML="",u("Success!","Model removed successfully")}else u("Alert!","Please select atleast one model")}}function Ae(e){const t=document.getElementById("availableModal").querySelector("li.selectedValue");if(!t){u("Alert!","Please select a model");return}if(t.getAttribute("dbtype")!="SQLITE"){u("Alert!","Method is applicable only for SQLITE type models");return}else{const d=t.innerText,n=t.getAttribute("project"),l=t.getAttribute("template"),o=t.getAttribute("dbtype"),[i,c]=B("Save As","Save"),s=a("div","form-group mb-4");s.appendChild(H("new_modelName_div","New Model Name","new_model_name","normal",[],"","fas fa-database")),i.appendChild(s),c.onclick=async function(r){const m=document.getElementById("new_model_name").value;if(m.trim()==""||!ae(m)){u("Alert!","Please enter valid model name");return}for(let E of document.getElementById("availableModal").querySelectorAll("li"))if(m.trim()==E.innerText){u("Alert!",`Model already active with same name ${m}`);return}b.getInstance(S).hide();const y=await C("home","saveAsModel",{new_model_name:m,new_model_template:l,project_name:n,model_name:d});if(y.message.indexOf("Invalid")>-1){u("Alert",y.message);return}let h=document.getElementById("availableModal");h.appendChild(j([m,l,n,o])),h.lastChild.click(),u("Success!","Save As Model added")}}}function Ie(e){const t=document.getElementById("availableModal").querySelector("li.selectedValue");if(!t){u("Alert!","Please select a model");return}const d=t.innerText;t.getAttribute("template");const[n,l]=B("Restore Model","Upload"),o=a("input","form-control"),i=a("div","input-group",null,o);o.setAttribute("type","file"),o.setAttribute("accept",".db, .sqlite3"),n.appendChild(i),l.onclick=async function(c){o.files[0]?(l.setAttribute("disabled",""),l.innerHTML='<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>',await ue("home","uploadModel",o.files[0],{model_name:d}),o.value=null,l.removeAttribute("disabled",""),l.innerHTML="Upload",b.getInstance(S).hide(),u("Success!","Model uploaded successfully"),W(d)):u("Alert!","Please choose a model")}}async function Se(e){let t=document.getElementById("data-loader");const d=document.getElementById("availableModal").querySelector("li.selectedValue");if(!d){u("Alert!","Please select a model");return}const n=d.innerText,l=d.getAttribute("project");t.style.display="",await C("home","downloadModel",{model_name:n,project_name:l}),t.style.display="none"}function ve(e){const t=document.getElementById("availableModal").querySelector("li.selectedValue");if(!t){u("Alert!","Please select a model");return}const d=t.innerText,[n,l]=B("Upload Excel","Upload"),o=a("input","form-control"),i=a("div","input-group",null,o);o.setAttribute("type","file"),o.setAttribute("accept","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"),n.appendChild(i),l.onclick=async function(c){U=o.files[0],U?(l.setAttribute("disabled",""),l.innerHTML='<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>',O={},O=await me(d,[],U),b.getInstance(document.getElementById("scc-one-modal")).hide(),new b(document.getElementById("modal-uploadExcel-info")).show(),o.value=null,l.innerHTML="Upload",l.removeAttribute("disabled","")):u("Alert!","Please choose a file")}}document.getElementById("modal-uploadExcel-info").addEventListener("show.bs.modal",function(){const e=this.querySelector(".modal-body");e.innerHTML="";const t=a("tr"),d=a("div","form-group",null,a("table","table table-bordered table-sm",null,a("thead",null,null,t)));d.style.maxHeight="300px",d.style.overflowY="auto",t.appendChild(a("td","text-center",null,a("h6","m-0",null,document.createTextNode("Sheet Name")))),t.appendChild(a("td","text-center",null,a("h6","m-0",null,document.createTextNode("Upload Option"))));const n=a("tbody");d.firstChild.appendChild(n),e.appendChild(d);for(let l in O){let o=a("tr","");o.appendChild(a("td",null,null,document.createTextNode(l)));const i=a("select","form-select");i.style="line-height:1 !important;";const c=[{value:"purgeAndUpload",text:"Purge and Upload"},{value:"createAndUpload",text:"Drop Table and Upload"},{value:"ignore",text:"Ignore"}],s=[{value:"ignore",text:"Ignore"},{value:"createAndUpload",text:"Create and Upload"}];O[l][0]==="New"?s.forEach(m=>{const f=a("option");f.value=m.value,f.textContent=m.text,i.appendChild(f)}):c.forEach(m=>{const f=document.createElement("option");f.value=m.value,f.textContent=m.text,m.value=="ignore"&&O[l][1]!="Input"&&f.setAttribute("Selected",""),i.appendChild(f)});let r=a("td","text-center",null,i);o.appendChild(r),n.appendChild(o)}});document.getElementById("saveFileName").onclick=async function(){this.setAttribute("disabled",""),this.innerHTML='<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>';const e=document.getElementById("availableModal").querySelector("li.selectedValue"),t=e.innerText;e.getAttribute("template");const d=document.getElementById("modal-uploadExcel-info").querySelector("tbody"),n={};for(let o of d.querySelectorAll("tr")){const i=o.firstElementChild.innerText,c=o.querySelector("select").value;n[i]=c}const l=await pe(t,Object.keys(n),U,n);b.getInstance(document.getElementById("modal-uploadExcel-info")).hide(),u("Success!","Excel uploaded successfully"),ke(l,n),W(t),this.innerText="Upload",this.removeAttribute("disabled")};function ke(e,t){const[d,n]=B("Status","OK"),l=a("tr",null,null,a("td",null,null,document.createTextNode("SheetName"))),o=a("div","form-group mb-4",null,a("table","table table-bordered table-sm",null,a("thead",null,null,l)));o.style.maxHeight="300px",o.style.overflowY="auto",o.style.overflowX="auto",l.appendChild(a("td",null,null,document.createTextNode("Status"))),l.appendChild(a("td",null,null,document.createTextNode("Msg")));const i=a("tbody");o.firstChild.appendChild(i);for(let c in e){let s=a("tr");s.appendChild(a("td",null,null,document.createTextNode(c)));let r,m;!isNaN(e[c])&&t[c]=="createAndUpload"?(r="Create And Uploaded",m=`${e[c]} rows inserted`):isNaN(e[c]&&t[c]=="purgeAndUpload")?(r="Errored",m=e[c]):(r="Purge And Uploaded",m=`${e[c]} rows inserted`),s.appendChild(a("td",null,null,document.createTextNode(r))),s.appendChild(a("td",null,null,document.createTextNode(m))),i.appendChild(s)}d.appendChild(o),new b(document.getElementById("scc-one-modal")).show(),n.onclick=function(){b.getInstance(S).hide()}}function Ce(e){const t=document.getElementById("availableModal").querySelector("li.selectedValue");if(!t){u("Alert!","Please select a model");return}const d=[];for(let g of document.getElementById("tableGroup").querySelectorAll("button.accordion-button"))d.push(g.innerText);const n=t.innerText,[l,o]=B("Download Excel","Download"),i=a("input","form-check-input round-check"),c=a("div","form-check",null,i);i.setAttribute("type","checkbox"),i.checked=!0,c.appendChild(a("label","form-check-label",null,document.createTextNode("Input Tables Only")));for(let g of d){let T=c.cloneNode(!0);T.lastChild.innerText=g,l.appendChild(T)}const s=S.querySelector(".modal-footer");s.innerHTML="";const r=a("div","w-100"),m=a("input","form-check-input form-check-sm round-check","emptyCheck");m.type="checkbox",m.checked=!0;const f=a("label","form-check-label small text-muted",null,document.createTextNode("Include Empty Tables"));f.setAttribute("for","emptyCheck");const y=a("div","form-check mb-0",null);y.appendChild(m),y.appendChild(f);const h=a("button","btn btn-tertiary",null,document.createTextNode("Cancel"));h.setAttribute("type","button"),h.setAttribute("data-bs-dismiss","modal");const E=a("button","btn btn-primary ml-2",null,document.createTextNode("Download"));E.setAttribute("type","button");const x=a("div","d-flex justify-content-between align-items-center",null);x.appendChild(h),x.appendChild(E),r.appendChild(y),r.appendChild(x),s.appendChild(r),E.onclick=async function(g){let T=[];for(let M of l.querySelectorAll("input:checked"))T.push(M.parentNode.lastChild.innerText);b.getInstance(S).hide();let k=document.getElementById("dl_progress_div");k.querySelector("div").innerText="Downloading",k.style.display="";const R=document.getElementById("emptyCheck").checked;await ye(n,[],T,R),k.querySelector("div").innerText="Running",k.style.display="none"}}async function xe(e){let t=document.getElementById("data-loader");const d=document.getElementById("availableModal").querySelector("li.selectedValue");if(!d){u("Alert!","Please select a model");return}const n=d.innerText;t.style.display="",await p("executeQuery",n,"VACUUM"),t.style.display="none",u("Success!","Model vacuumed successfully")}async function Be(){const e=document.getElementById("viewName").value,t=document.getElementById("query-input").value,d=document.getElementById("availableModal").querySelector("li.selectedValue").innerText;if(!d){u("Alert!","Please select a model");return}(e.trim()==""||t.trim()=="")&&u("Alert!","Please make sure that View Name and Query was entered"),await C("home","checkOrCreateView",{view_name:e,view_query:t,model_name:d,isExist:!1}),b.getInstance(document.getElementById("modal-createView")).hide(),u("Success","View created successfully"),W(d)}function ae(e){var t=/^[a-zA-Z0-9_]+$/;return t.test(e)}function De(e){const t=document.getElementById("outputTxt");if(e){const d=document.createElement("div");d.textContent=`Error: ${e}`,d.style.color="red",t.appendChild(d)}}async function $(e){const t=document.getElementById("taskDiv");t.innerHTML="";const n=await p("fetchData",e,"SELECT TaskId,TaskName,TaskDisplayName,TaskType FROM S_TaskMaster");for(let[l,o,i,c]of n){const s=a("li","d-flex",null),r=a("a","dropdown-item",null,document.createTextNode(i)),m=a("button","btn btn-small edit-btn transparent p-2 me-1",null,a("span","fa-solid fa-pencil")),f=a("button","btn btn-small del-btn transparent p-2 me-1",null,a("span","fa-solid fa-trash-alt"));s.appendChild(r),s.appendChild(m),s.appendChild(f),s.querySelector("button.edit-btn").title="Edit Task",s.querySelector("button.del-btn").title="Delete Task",s.querySelector("button.edit-btn").onclick=async function(y){y.stopPropagation();const h=document.getElementById("upScName");let E=s.innerText.trim();h.innerHTML="";let g=await p("fetchData",e,"SELECT TaskDisplayName, TaskType, TaskName, TaskId FROM S_TaskMaster WHERE TaskDisplayName = ?",[E]);P=g[0][3];let T=g[0][1];if(T=="PythonScript"?T="PScript":T==="PythonNotebook"?T="Python":T==="RNotebook"?T="R":T==="JSNotebook"&&(T="Javascript"),g&&g.length>0){document.getElementById("upDsName").value=g[0][0],document.getElementById("upScType").value=T;let v,k;T==="PScript"?(v="SELECT FileName FROM S_ExecutionFiles WHERE FileName IS NOT NULL AND FileName LIKE '%.py' AND FilePath NOT LIKE '%/%' AND Status = ?",k=await p("fetchData",e,v,["Active"])):(v="SELECT Name FROM S_Notebooks WHERE Status = ? AND Type = ?",k=await p("fetchData",e,v,["Active",T]));for(const R of k){const M=a("option",null,null,document.createTextNode(R));M.setAttribute("value",R),h.appendChild(M)}document.getElementById("upScName").value=g[0][2],new b(document.getElementById("modal-updateScript")).show()}},s.querySelector("button.del-btn").onclick=async function(y){y.stopPropagation(),u("Alert!",`Are you sure you want to delete ${i}?`,async function(){let h=c;h==="JavascriptNotebook"&&(h="JSNotebook"),await p("deleteData",e,"DELETE FROM S_TaskMaster WHERE TaskId = ? AND TaskType = ? AND TaskName = ?",[l,h,o]),u("Success","Script Deleted Successfully"),$(e)},1)},s.onclick=async function(){const y=document.getElementById("myCanvas");y.style.display=="none"&&(y.style.display=""),document.getElementById("loadingOverlay").classList.remove("hidden"),document.getElementById("outputDiv").style.display="",document.getElementById("outputTxt").innerHTML="",document.getElementById("downloadOutput").hasAttribute("disabled")&&document.getElementById("downloadOutput").removeAttribute("disabled");const h=document.getElementById("currCell").querySelector(".cell-bottom");h&&h.innerHTML.trim()!==""&&(h.innerHTML=""),G=null;const E=document.getElementById("availableModal").querySelector("li.selectedValue"),x=E.getAttribute("project");let g,T;if(c==="PythonScript")T="SELECT FilePath,FileData,FileName FROM S_ExecutionFiles WHERE FileName IS NOT NULL AND Status = 'Active'",g=await p("fetchData",E.innerText,T);else{c=="JSNotebook"&&(c="JavascriptNotebook",window.loadCDNScripts=async function(N){const I=(D,F)=>new Promise((L,ie)=>{if(F&&window[F]){L(window[F]);return}const q=document.createElement("script");q.src=D,q.async=!0,q.onload=()=>L(window[F]||!0),q.onerror=()=>ie(new Error(`Failed to load script: ${D}`)),document.head.appendChild(q)});return Promise.all(N.map(D=>I(D.url,D.globalVar)))},window.loadCDNStylesheets=async function(N){return Promise.all(N.map(({url:I})=>new Promise((D,F)=>{const L=document.createElement("link");L.rel="stylesheet",L.href=I,L.onload=()=>D(I),L.onerror=()=>F(`Failed to load CSS: ${I}`),document.head.appendChild(L)})))},window.getData=async(N,I=[])=>p("getData",e,N,I),window.executeQuery=async(N,I=[])=>p("updateData",e,N,I)),T="SELECT Name,CellContent,Name FROM S_NotebookContent WHERE Name = ? AND CellType = ?";const _=await p("fetchData",E.innerText,T,[o,c.replace("Notebook","").toLowerCase()]);let A=[];for(const N of _)A.push(N[1]);g=[[_[0][0],A,_[0][0]]]}let v=null,k="";g.forEach(_=>{_[0]===o&&(v=_[1],k=_[2])});const M=await p("fetchData",E.innerText,"SELECT FileName,FileBlob FROM S_DataFiles WHERE FileType = 'Input'"),z=await p("fetchData",E.innerText,"SELECT WheelName,WheelBlob FROM S_PackageWheels");await p("updateData",E.innerText,"UPDATE S_Taskmaster SET TaskLastRunDate = ? WHERE TaskId = ? ",[Me(),l]);const X=await Q(o,"Started",null,null,l);let w;if(c=="PythonScript"){let _="";for(let A of v)_+=A;w=await J("execute","editor",_,x,E.innerText,g,k,M,z)}else if(c=="PythonNotebook")for(let _ of v)w=await J("execute","notebook",_,x,E.innerText,g,null,M,z,"currCell");else if(c=="JavascriptNotebook")for(let _ of v)w=await fe("currCell",_);else if(c=="RNotebook")for(let _ of v)w=await he("currCell",_,E.innerText,M);if(w.stderr)Q(o,"Errored",w.stderr,X);else{if(w.blob){const _=y.getContext("2d");_.clearRect(0,0,y.width,y.height),G=w.blob;const A=await createImageBitmap(w.blob),N=Math.min(y.width/A.width,y.height/A.height),I=(y.width-A.width*N)/2,D=(y.height-A.height*N)/2;_.drawImage(A,I,D,A.width*N,A.height*N),new b(document.getElementById("modal-show-output")).show()}Q(o,"Completed",null,X),w.outputFiles&&w.outputFiles.length>0&&(await p("deleteData",E.innerText,"DELETE FROM S_DataFiles WHERE FileType = 'Output'"),w.outputFiles.forEach(async([A,N])=>{await p("insertData",E.innerText,`INSERT INTO S_DataFiles (FileName,FileType,FileBlob) 
                                            VALUES (?, ?, ?) ON CONFLICT (FileName,FileType) DO UPDATE SET FileBlob = ? `,[A,"Output",N,N])}))}w.success&&c!="PythonScript"&&(new b(document.getElementById("modal-show-output")).show(),y.style.display="none",document.getElementById("downloadOutput").setAttribute("disabled","true")),document.getElementById("loadingOverlay").classList.add("hidden"),De(w.stderr)},t.appendChild(s)}}function Me(){const e=new Date,t=e.getFullYear(),d=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),i=String(e.getSeconds()).padStart(2,"0");return`${t}-${d}-${n} ${l}:${o}:${i}`}async function Q(e,t,d=null,n=null,l=null){const o=document.getElementById("availableModal").querySelector("li.selectedValue");if(n)await p("updateData",o.innerText,`UPDATE T_TaskLogs SET TaskStatus = ?,ErrorMsg = ?, EndDate = datetime('now', 'localtime')
                     WHERE TaskName = ? AND Id = ? `,[t,d,e,n]);else return await p("insertData",o.innerText,"INSERT INTO T_TaskLogs (TaskId,TaskName,TaskStatus,EndDate) VALUES (?, ?, ?, datetime('now', 'localtime'))",[l,e,t])}async function Le(){this.setAttribute("disabled",""),this.innerHTML='<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>';const e=document.getElementById("availableModal").querySelector("li.selectedValue"),t=document.getElementById("inpFiles");if(t.files.length>0){await p("executeQuery",e.innerText,"DELETE FROM S_DataFiles;",["script"]);for(const n of t.files){const l=await n.arrayBuffer();await p("insertData",e.innerText,`INSERT INTO S_DataFiles (FileName,FileType,FileBlob) 
                            VALUES (?, ?, ?) ON CONFLICT (FileName,FileType) DO UPDATE SET FileBlob = ? `,[n.name,"Input",new Uint8Array(l),new Uint8Array(l)])}this.removeAttribute("disabled",""),this.innerHTML="Upload",b.getInstance(document.getElementById("modal-upload-files")).hide(),u("Success","Files Upload Successfully.")}t.value=null}async function K(){const e=document.getElementById("modal-input-files").querySelector(".modal-body");e.innerHTML="";const t=document.getElementById("availableModal").querySelector("li.selectedValue"),n=await p("fetchData",t.innerText,"SELECT FileId,FileName FROM S_DataFiles WHERE FileType = 'Input' "),l=a("tr"),o=a("div","form-group",null,a("table","table table-bordered table-sm",null,a("thead",null,null,l)));o.style.maxHeight="300px",o.style.overflowY="auto";const i=a("tbody");o.firstChild.appendChild(i),e.appendChild(o);for(let r of n){const m=a("tr","d-flex align-items-center");m.appendChild(a("td","w-100",null,document.createTextNode(r[1])));const f=a("td","input-file-icon m-0 px-2");let y=a("span","fa fa-trash");y.onclick=Re.bind(null,r[1],r[0]),f.appendChild(y);const h=a("td","input-file-icon m-0 px-2");let E=a("span","fa fa-download");E.onclick=de.bind(null,r[1],r[0]),h.appendChild(E);const x=a("td","input-file-icon m-0 px-2");let g=a("span","fa fa-upload");g.onclick=le.bind(null,r[1],r[0]),x.appendChild(g),m.appendChild(f),m.appendChild(x),m.appendChild(h),i.appendChild(m)}const c=a("div","d-flex justify-content-end");let s=a("button","btn btn-primary",null,document.createTextNode("Add File"));c.appendChild(s),e.appendChild(c),s.onclick=le}async function Fe(){const e=document.getElementById("modal-input-files").querySelector(".modal-body");e.innerHTML="";const t=document.getElementById("availableModal").querySelector("li.selectedValue"),n=await p("fetchData",t.innerText,"SELECT FileId,FileName FROM S_DataFiles WHERE FileType = 'Output' "),l=a("tr"),o=a("div","form-group",null,a("table","table table-bordered table-sm",null,a("thead",null,null,l)));o.style.maxHeight="300px",o.style.overflowY="auto";const i=a("tbody");o.firstChild.appendChild(i),e.appendChild(o);for(let c of n){const s=a("tr","d-flex align-items-center");s.appendChild(a("td","w-100",null,document.createTextNode(c[1])));const r=a("td","input-file-icon m-0 px-2");let m=a("span","fa fa-download");m.onclick=de.bind(null,c[1],c[0]),r.appendChild(m),s.appendChild(r),i.appendChild(s)}}async function Re(e,t){const d=document.getElementById("availableModal").querySelector("li.selectedValue");await p("deleteData",d.innerText,"DELETE FROM S_DataFiles WHERE FileType = 'Input' AND FileId = ? AND FileName = ? ",[t,e]),K()}async function de(e,t){let d=document.getElementById("modal-input-files").querySelector("h2").innerText.indexOf("Input")>-1?"Input":"Output";const n=document.getElementById("availableModal").querySelector("li.selectedValue"),o=await p("fetchData",n.innerText,"SELECT FileName,FileBlob FROM S_DataFiles WHERE FileType = ? AND FileID = ? AND FileName = ?",[d,t,e]);if(o){const c=new Blob([o[0][1]]);if(window.navigator&&window.navigator.msSaveOrOpenBlob){window.navigator.msSaveOrOpenBlob(c);return}const s=window.URL.createObjectURL(c);var i=document.createElement("a");i.href=s,i.download=e,i.click(),setTimeout(function(){window.URL.revokeObjectURL(s)},1e3)}else u("Alert!","No File Exists")}function le(e=null,t=null){b.getInstance(document.getElementById("modal-input-files")).hide();const d=document.getElementById("availableModal").querySelector("li.selectedValue"),[n,l]=B("Upload Excel","Upload"),o=a("input","form-control"),i=a("div","input-group",null,o);o.setAttribute("type","file"),n.appendChild(i),l.onclick=async function(c){if(o.files[0]){l.setAttribute("disabled",""),l.innerHTML='<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>';const s=await o.files[0].arrayBuffer();e&&t?await p("updateData",d.innerText,"UPDATE S_DataFiles SET FileBlob = ? WHERE FileType = 'Input' AND FileName = ? AND FileId = ? ",[o.files[0].name,new Uint8Array(s),e,t]):await p("insertData",d.innerText,"INSERT INTO S_DataFiles (FileName,FileType,FileBlob) VALUES (?, ?, ?) ON CONFLICT (FileName,FileType) DO UPDATE SET FileBlob = ?",[o.files[0].name,"Input",new Uint8Array(s),new Uint8Array(s)]),b.getInstance(document.getElementById("scc-one-modal")).hide(),new b(document.getElementById("modal-input-files")).show(),o.value=null,l.innerHTML="Upload",l.removeAttribute("disabled",""),K()}else u("Alert!","Please choose a file")},new b(document.getElementById("scc-one-modal")).show()}async function qe(){let e=document.getElementById("modal-input-files").querySelector("h2").innerText.indexOf("Input")>-1?"Input":"Output";const t=document.getElementById("availableModal").querySelector("li.selectedValue");try{const n=await p("fetchData",t.innerText,"SELECT FileName,FileBlob FROM S_DataFiles WHERE FileType = ?",[e]);if(!n||n.length===0){u("Alert!","No files found to download.");return}const l=new be;n.forEach(c=>{l.file(c[0],c[1])});const o=await l.generateAsync({type:"blob"}),i=document.createElement("a");i.href=window.URL.createObjectURL(o),i.download="InputFiles.zip",i.click(),setTimeout(function(){window.URL.revokeObjectURL(i.href)},1e3)}catch(d){console.error("Error creating zip file for download:",d)}}async function Oe(e){const t=document.getElementById("availableModal").querySelector("li.selectedValue");if(!t){u("Alert!","Please select a model");return}const[d,n]=B("Upload Package","Upload"),l=a("input","form-control"),o=a("div","input-group",null,l);l.setAttribute("type","file"),l.setAttribute("accept",".whl"),d.appendChild(o),n.onclick=async function(i){if(l.files[0]){n.setAttribute("disabled",""),n.innerHTML='<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>';const s=await l.files[0].arrayBuffer();try{await p("insertData",t.innerText,"INSERT INTO S_PackageWheels (WheelName,WheelBlob) VALUES (?, ?) ON CONFLICT (WheelName) DO UPDATE SET WheelBlob = ?",[l.files[0].name,new Uint8Array(s),new Uint8Array(s)]),u("Success","Package uploaded successfully!")}catch(r){console.error("Error saving file:",r)}b.getInstance(document.getElementById("scc-one-modal")).hide(),l.value=null,n.innerHTML="Upload",n.removeAttribute("disabled","")}else u("Alert!","Please choose a file")}}async function Ue(){const e=document.createElement("a");e.href=window.URL.createObjectURL(G),e.download="output.jpg",e.click(),setTimeout(function(){window.URL.revokeObjectURL(e.href)},1e3)}document.getElementById("notebookBtn").onclick=function(){const e=document.getElementById("availableModal").querySelector("li.selectedValue");if(!e){u("Alert!","Please select a model");return}const t=e.innerText;window.open(`./PyNotebook.html?modelName=${t}`)};document.getElementById("notebookJS").onclick=function(){const e=document.getElementById("availableModal").querySelector("li.selectedValue");if(!e){u("Alert!","Please select a model");return}const t=e.innerText;window.open(`./JsNotebook.html?modelName=${t}`)};document.getElementById("sqlEditor").onclick=function(){const e=document.getElementById("availableModal").querySelector("li.selectedValue");if(!e){u("Alert!","Please select a model");return}const t=e.innerText;window.open(`./SQLiteStudio/playground/client.html?modelName=${t}`)};document.getElementById("notebookRBtn").onclick=function(){const e=document.getElementById("availableModal").querySelector("li.selectedValue");if(!e){u("Alert!","Please select a model");return}const t=e.innerText;window.open(`./RNotebook.html?modelName=${t}`)};document.getElementById("querySheet").onclick=function(){const e=document.getElementById("availableModal").querySelector("li.selectedValue");if(!e){u("Alert!","Please select a model");return}const t=e.innerText;window.open(`./Queries.html?modelName=${t}`)};document.getElementById("scType").onchange=async function(){const e=document.getElementById("scType").value,t=document.getElementById("availableModal").querySelector("li.selectedValue"),d=document.getElementById("scName");if(d.innerHTML="",!t){u("Alert!","Please select a model");return}let n,l;e==="PScript"?(n="SELECT FileName FROM S_ExecutionFiles WHERE FileName IS NOT NULL AND FileName LIKE '%.py' AND FilePath NOT LIKE '%/%' AND Status = ?",l=await p("fetchData",t.innerText,n,["Active"])):(n="SELECT Name FROM S_Notebooks WHERE Status = ? AND Type = ?",l=await p("fetchData",t.innerText,n,["Active",e]));for(const o of l){const i=a("option",null,null,document.createTextNode(o));i.setAttribute("value",o),d.appendChild(i)}};document.getElementById("ok-script").onclick=async function(){const e=document.getElementById("dsName").value,t=document.getElementById("scType").value,d=document.getElementById("scName").value,n=document.getElementById("availableModal").querySelector("li.selectedValue");if(e.trim()===""){u("Alert!","Please Enter a display ame");return}if(t==="0"){u("Alert!","Please select a script language");return}if(d==="0"){u("Alert!","Please select a notebook");return}let l;if(t==="Python"?l="PythonNotebook":t==="R"?l="RNotebook":t==="Javascript"?l="JSNotebook":t==="PScript"&&(l="PythonScript"),(await p("fetchData",n.innerText,"SELECT TaskDisplayName FROM S_TaskMaster WHERE TaskDisplayName = ?",[e])).length>0){u("Alert!","Display name already exists");return}if((await p("fetchData",n.innerText,"SELECT TaskName, TaskDisplayName FROM S_TaskMaster WHERE TaskName = ? AND TaskType = ?",[d,l])).length>0){u("Alert!","Script with this name already exists");return}await p("insertData",n.innerText,"INSERT INTO S_TaskMaster (TaskName,TaskDisplayName,TaskType) VALUES (?, ?, ?)",[d,e,l]),await $(n.innerText),b.getInstance(document.getElementById("modal-addScript")).hide(),document.getElementById("dsName").value="",document.getElementById("scType").value="0",document.getElementById("scName").innerHTML="",u("Success","Script created successfully.")};document.getElementById("upScType").onchange=async function(){const e=document.getElementById("upScType").value,t=document.getElementById("availableModal").querySelector("li.selectedValue"),d=document.getElementById("upScName");if(d.innerHTML="",!t){u("Alert!","Please select a model");return}let n,l;e==="PScript"?(n="SELECT FileName FROM S_ExecutionFiles WHERE FileName IS NOT NULL AND FileName LIKE '%.py' AND FilePath NOT LIKE '%/%' AND Status = ?",l=await p("fetchData",t.innerText,n,["Active"])):(n="SELECT Name FROM S_Notebooks WHERE Status = ? AND Type = ?",l=await p("fetchData",t.innerText,n,["Active",e]));for(const o of l){const i=a("option",null,null,document.createTextNode(o));i.setAttribute("value",o),d.appendChild(i)}};document.getElementById("update-script").onclick=async function(){const e=document.getElementById("upDsName").value,t=document.getElementById("upScType").value,d=document.getElementById("upScName").value,n=document.getElementById("availableModal").querySelector("li.selectedValue");if(e.trim()===""){u("Alert!","Please Enter a display ame");return}if(t==="0"){u("Alert!","Please select a script language");return}if(d==="0"){u("Alert!","Please select a notebook");return}let l;if(t==="Python"?l="PythonNotebook":t==="R"?l="RNotebook":t==="Javascript"?l="JSNotebook":t==="PScript"&&(l="PythonScript"),(await p("fetchData",n.innerText,"SELECT TaskDisplayName FROM S_TaskMaster WHERE TaskDisplayName = ? AND TaskId != ?",[e,P])).length>0){u("Alert!","Display name already exists");return}if((await p("fetchData",n.innerText,"SELECT TaskName, TaskDisplayName FROM S_TaskMaster WHERE TaskName = ? AND TaskType = ? AND TaskId != ?",[d,l,P])).length>0){u("Alert!","Script with this name already exists");return}await p("updateData",n.innerText,"UPDATE S_TaskMaster SET TaskName = ?, TaskDisplayName = ?,TaskType = ? WHERE TaskId = ?",[d,e,l,P]),await $(n.innerText),b.getInstance(document.getElementById("modal-updateScript")).hide(),document.getElementById("upDsName").value="",document.getElementById("upScType").value="0",document.getElementById("upScName").innerHTML="",u("Success","Script updated successfully.")};
