import"./pixel.PHV1U_RE.js";import{C as M}from"./codemirror.BeiFTLV5.js";import"./python.CRxt_0kd.js";import{e as d,c as E,v as U,w as V,x as A,b as F}from"./scc.CDoRPkO3.js";import{M as T}from"./bootstrap.esm.CkDf0L-y.js";const R=new URLSearchParams(window.location.search);let c=R.get("modelName"),I=R.get("projectName");var S=null;let u=null,p=null,_=null;window.onload=async function(){document.querySelectorAll(".modal").forEach(o=>{T.getInstance(o)||new T(o)}),S=M.fromTextArea(document.getElementById("editorText"),{lineNumbers:!0,lineWrapping:!0,mode:"python",theme:"dracula",autoRefresh:!0,autofocus:!0,tabSize:4,indentUnit:4}),S.addKeyMap({Backspace:function(o){const s=o.getCursor(),r=o.getLine(s.line),y=o.getOption("indentUnit"),h=r.slice(0,s.ch);if(/^\s*$/.test(h)&&s.ch>0){const g=Math.max(0,s.ch-y);o.setCursor({line:s.line,ch:g})}else o.execCommand("delCharBefore")}});let t=await d("init");if(!t||t.msg!="Success"){E("Alert!","Some error occured while initializing sqlite.");return}if(!c)if((await U("home","getUserModels")).some(r=>r[0]==="Default_DB"))c="Default_DB",I="Default";else{let r=await V();if(r.length>0)c=r[0],I="Default";else{E("Alert!","Model Name not found in the URL.");return}}b();const i=await d("fetchData",c,"SELECT FileName,FileData FROM S_ExecutionFiles WHERE FilePath = ? AND Status = 'Active' ",["requirements.txt"]),a=await d("fetchData",c,"SELECT WheelName,WheelBlob FROM S_PackageWheels");let m=await A("init","editor","",I,c,i,"",[],a),f=document.getElementById("packageIndicator");v(m.stderr),f.classList.remove("spinner-loading"),f.classList.add("spinner-complete"),document.getElementById("downloadZip").onclick=J,document.getElementById("downloadOutput").onclick=Y,document.getElementById("getText").onclick=H,document.getElementById("uploadZip").onclick=W,document.getElementById("hideCanvas").onclick=Q,document.getElementById("addFile").onclick=j,document.getElementById("addFolder").onclick=Z,document.getElementById("deleteFile").onclick=G,document.getElementById("addToHome").onclick=K,document.getElementById("saveFileName").onclick=X};function N(e){S.setValue(e),setTimeout(function(){S.refresh(),S.focus()},200)}async function H(){_=null,document.getElementById("loadingOverlay").classList.remove("hidden"),document.getElementById("outputTxt").innerHTML="";const e=document.getElementById("myCanvas");let t=S.getValue();const i=await d("fetchData",c,"SELECT FilePath,FileData FROM S_ExecutionFiles WHERE Filename is NOT NULL AND Status = 'Active' ");let l="";u&&(l=u.getAttribute("filepath"),await C());const m=await d("fetchData",c,"SELECT FileName,FileBlob FROM S_DataFiles WHERE FileType = 'Input'"),o=await d("fetchData",c,"SELECT WheelName,WheelBlob FROM S_PackageWheels"),s=await L("Started");let r=await A("execute","editor",t,I,c,i,l,m,o);if(document.getElementById("loadingOverlay").classList.add("hidden"),r.stderr)L("Errored",r.stderr,s);else{L("Completed",null,s);const y=e.getContext("2d");if(y.clearRect(0,0,e.width,e.height),r.blob){_=r.blob;const h=await createImageBitmap(r.blob),g=Math.min(e.width/h.width,e.height/h.height),w=(e.width-h.width*g)/2,D=(e.height-h.height*g)/2;y.drawImage(h,w,D,h.width*g,h.height*g);const q=document.getElementById("canvasDiv");q.style.width!="500px"&&(q.style.width="500px",document.getElementById("mainDiv").style.marginRight="513px")}r.outputFiles&&r.outputFiles.length>0&&(await d("deleteData",c,"DELETE FROM S_DataFiles WHERE FileType = 'Output'"),r.outputFiles.forEach(async([g,w])=>{await d("insertData",c,`INSERT INTO S_DataFiles (FileName,FileType,FileBlob) 
                              VALUES (?, ?, ?) ON CONFLICT (FileName,FileType) DO UPDATE SET FileBlob = ? `,[g,"Output",w,w])}))}v(r.stderr)}function v(e){const t=document.getElementById("outputTxt");if(e){const n=document.createElement("div");n.textContent=`Error: ${e}`,n.style.color="red",t.appendChild(n)}}async function C(){const e=document.getElementById("filesDiv").querySelector("li.selectedValue");if(e){const t=e.getAttribute("filepath"),n=e.innerText,i=S.getValue();if(n==="requirements.txt"){const a=await A("loadPackages","editor",i);a.stderr&&v(a.stderr)}await d("insertData",c,`INSERT INTO S_ExecutionFiles (FileName,FilePath,FileData) VALUES (?, ?, ?) ON CONFLICT (FilePath)
                  DO UPDATE SET FileData = ? `,[n,t,i,i])}}async function W(){const e=document.getElementById("zipFile").files[0];if(e){this.setAttribute("disabled",""),this.innerHTML='<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>',await d("deleteData",c,"DELETE FROM S_ExecutionFiles");const n=new FileReader;n.onload=async function(i){const l=await JSZip.loadAsync(i.target.result),a=[];l.forEach(function(o,s){if(o.includes("__pycache__"))return;const r=s.async("string").then(async function(y){if(y){const h=o.split("/").slice(-1)[0];await d("insertData",c,`INSERT INTO S_ExecutionFiles (FileName,FilePath,FileData) VALUES (?, ?, ?) 
                         ON CONFLICT (FilePath) DO UPDATE SET FileData = ?, FilePath = ?`,[h,o,y,y,o])}});a.push(r)}),await Promise.all(a);const m=document.getElementById("uploadZip");m.removeAttribute("disabled"),m.innerHTML="",m.innerText="Upload",N(""),b(),T.getInstance(document.getElementById("modal-file-upload")).hide(),E("Success","File Uploaded Successfully")},n.readAsArrayBuffer(e)}}function k(e,t=!1,n=null,i=null,l="",a="fa-solid fa-folder"){let m=F("ul","tree");for(let f in e)if(m.appendChild(document.createElement("li")),e[f]&&typeof e[f]=="object"){l+=l?`/${f}`:f;let o=B(f,a);o.setAttribute("folderPath",l),o.onclick=function(r){if(!this.classList.contains("selectedFolder")){for(let y of document.getElementById("filesDiv").querySelectorAll("li.selectedFolder"))y.classList.remove("selectedFolder");for(let y of document.getElementById("filesDiv").querySelectorAll("li.selectedValue"))y.classList.remove("selectedValue");this.classList.add("selectedFolder"),r.preventDefault(),p=this,u=null}};let s=F("ul","childList TreeMembers");s.appendChild(k(e[f],!1,n,i,l)),m.appendChild(o),m.appendChild(s),l=l.replace(/\/[^\/]+$/,"")}else{if(!e[f])continue;let o=B(f,"fa-file-alt",e[f],i,n);o.onclick=async function(s){if(!this.classList.contains("selectedValue")){document.getElementById("outputTxt").innerHTML="",document.getElementById("loadingOverlay").classList.remove("hidden"),await C(),document.getElementById("loadingOverlay").classList.add("hidden");const r=document.getElementById("bottomButtons");r.style.display="";for(let D of document.getElementById("filesDiv").querySelectorAll("li.selectedValue"))D.classList.remove("selectedValue");for(let D of document.getElementById("filesDiv").querySelectorAll("li.selectedFolder"))D.classList.remove("selectedFolder");this.classList.add("selectedValue"),s.preventDefault(),p=null,u=this;const y=this.getAttribute("filepath");y.slice(-4)===".txt"&&(r.style.display="none");const w=await d("fetchData",c,"SELECT FileName,ifnull(FileData,'') FROM S_ExecutionFiles WHERE FilePath = ? AND Status = 'Active' ",[y]);w&&w[0]&&N(w[0][1])}},m.appendChild(o)}return t?F("div","card-body scc-box",null,m):F("div",null,null,m)}function B(e,t,n=null,i=null,l=null){let a=F("li",null,null);i&&l&&n&&e==l&&n==i&&a.classList.add("selectedValue"),a.setAttribute("title",e),n&&a.setAttribute("filepath",n);let m=F("label","checkBox-label",null,F("span",`fas ${t}`));return m.appendChild(document.createTextNode(e)),a.appendChild(m),a}async function b(e=null,t=null){const i=await d("fetchData",c,"SELECT FilePath FROM S_ExecutionFiles"),l={};i.forEach(m=>{const f=m[0].split("/");let o=l;f.forEach((s,r)=>{s&&(r===f.length-1?/^[^\s]+\.(py|txt)$/.test(s)?o[s]=m[0]:o[s]={}:(o[s]=o[s]||{},o=o[s]))})});const a=P(l);document.getElementById("filesDiv").innerHTML="",document.getElementById("filesDiv").appendChild(k(a,!0,e,t))}function P(e){const t={},n=Object.keys(e).filter(l=>typeof e[l]=="object"),i=Object.keys(e).filter(l=>typeof e[l]!="object");if(n.sort().forEach(l=>{t[l]=P(e[l])}),i.sort().forEach(l=>{t[l]=e[l]}),t["requirements.txt"]){const l=t["requirements.txt"];delete t["requirements.txt"],t["requirements.txt"]=l}return t}function Q(){const e=document.getElementById("canvasDiv");e.style.width=="500px"&&(e.style.width="0",document.getElementById("mainDiv").style.marginRight="0px")}function $(){let e=F("div","input-group mb-2"),t=F("input","form-control small-input");return t.type="text",t.addEventListener("keydown",async function(n){if(n.keyCode=="13"){const i=n.target.value;if(n.preventDefault(),/^[^\s]+\.(py|txt)$/.test(i)){let a=i;if(u?a=u.getAttribute("filepath").replace(u.innerText,i):p&&(a=p.getAttribute("folderpath")+`/${i}`),(await d("fetchData",c,"Select FileName FROM S_ExecutionFiles WHERE FileName = ? AND FilePath = ? ",[i,a])).length>0){E("Alert!","Filename Already Exists");return}await d("insertData",c,"INSERT INTO S_ExecutionFiles (FileName,FilePath) VALUES (?, ?) ",[i,a]),x(),await b(i,a);const s=document.getElementById("filesDiv").querySelector("li.selectedValue");if(s){u=s;const r=s.getAttribute("filepath"),h=await d("fetchData",c,"SELECT FileName,ifnull(FileData,'') FROM S_ExecutionFiles WHERE FilePath = ? AND Status = 'Active' ",[r]);h&&h[0]&&N(h[0][1])}}else E("Alert!","Invalid Filename")}}),e.appendChild(t),e}function j(){x();let e=document.querySelector(".tree");u?e=u.parentNode:p&&(e=p.nextElementSibling.querySelector(".tree"));let t=$();e.insertBefore(t,e.firstChild),t.querySelector("input").focus()}function x(){const e=document.querySelector("div.scc-box").querySelector(".input-group");e&&e.parentNode.removeChild(e)}function z(){let e=F("div","input-group mb-2"),t=F("input","form-control small-input");return t.type="text",t.addEventListener("keydown",async function(n){if(n.keyCode=="13"){const i=n.target.value;if(n.preventDefault(),/^[^\s]+$/.test(i)){let a=i;if(u?a=u.getAttribute("filepath").replace(u.innerText,i):p&&(a=p.getAttribute("folderpath")+`/${i}`),(await d("fetchData",c,"Select FilePath FROM S_ExecutionFiles WHERE FileName IS NULL AND FilePath = ? ",[a])).length>0){E("Alert!","Folder with same name already exists");return}await d("insertData",c,"INSERT INTO S_ExecutionFiles (FilePath) VALUES (?) ",[a]),x(),await b(i,a)}else E("Alert!","Invalid Folder name")}}),e.appendChild(t),e}function Z(){x();let e=document.querySelector(".tree");u?e=u.parentNode:p&&(e=p.nextElementSibling.querySelector(".tree"));let t=z();e.insertBefore(t,e.firstChild),t.querySelector("input").focus()}async function G(){if(!u&&!p){E("Alert!","No File Or Folder Selected to delete");return}let e=null;if(u){e=u.getAttribute("filepath"),E("Alert",`Are you sure want to delete '${u.innerText}'`,O.bind(null,e),1);return}else if(p){e=p.getAttribute("folderpath"),E("Alert",`Are you sure you want to permanently delete the '${p.innerText}' folder and all of its contents, including subfolders and files?`,O.bind(null,e),1);return}}async function O(e){await d("deleteData",c,"DELETE FROM S_ExecutionFiles WHERE FilePath Like ? OR FilePath = ?",[`%${e}%`,e]),N(""),u=null,p=null,await b()}async function J(){try{const t=await d("fetchData",c,"SELECT FilePath,FileData FROM S_ExecutionFiles");if(!t||t.length===0)return;const n=new JSZip;t.forEach(a=>{n.file(a[0],a[1],{binary:!0})});const i=await n.generateAsync({type:"blob"}),l=document.createElement("a");l.href=window.URL.createObjectURL(i),l.download="files.zip",l.click(),setTimeout(function(){window.URL.revokeObjectURL(l.href)},1e3)}catch(e){console.error("Error creating zip file for download:",e)}}async function K(){if(document.getElementById("fileName").value="",!u){E("Alert!","No file selected");return}new T(document.getElementById("modal-fileDisplayName")).show()}async function X(){const e=u.getAttribute("filepath"),t=document.getElementById("fileName").value;if(t.trim()==""){E("Alert","Please enter File Display Name");return}let n="INSERT INTO S_TaskMaster (TaskName,TaskDisplayName) VALUES (?, ?)";try{const i=await d("insertData",c,n,[e,t]);T.getInstance(document.getElementById("modal-fileDisplayName")).hide(),E("Success","File added to Home Page Successfully")}catch{E("Alert!","This File Name is already exists")}}async function Y(){const e=document.createElement("a");e.href=window.URL.createObjectURL(_),e.download="output.jpg",e.click(),setTimeout(function(){window.URL.revokeObjectURL(e.href)},1e3)}async function L(e,t=null,n=null){if(u){const i=u.innerText.trim();if(n)await d("updateData",c,`UPDATE T_TaskLogs SET TaskStatus = ?,ErrorMsg = ?, EndDate = datetime('now', 'localtime')
                     WHERE TaskName = ? AND Id = ? `,[e,t,i,n]);else return await d("insertData",c,"INSERT INTO T_TaskLogs (TaskName,TaskStatus,EndDate) VALUES (?, ?, datetime('now', 'localtime'))",[i,e])}}
