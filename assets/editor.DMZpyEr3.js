import"./pixel.PHV1U_RE.js";import{C as V}from"./codemirror.BeiFTLV5.js";import"./python.CRxt_0kd.js";import{v as W,e as d,c as g,w as H,x as Q,y as N,b as E}from"./scc.BdpBWn71.js";import{M as v}from"./bootstrap.esm.CkDf0L-y.js";import{J as R}from"./jszip.min.C5akSdVy.js";import"https://webr.r-wasm.org/latest/webr.mjs";const k=new URLSearchParams(window.location.search);let c=k.get("modelName"),b=k.get("projectName");var S=null;let f=null,p=null,A=null,B={};window.onload=async function(){document.querySelectorAll(".modal").forEach(o=>{v.getInstance(o)||new v(o)}),B=await W(),S=V.fromTextArea(document.getElementById("editorText"),{lineNumbers:!0,lineWrapping:!0,mode:"python",theme:"dracula",autoRefresh:!0,autofocus:!0,tabSize:4,indentUnit:4}),S.addKeyMap({Backspace:function(o){const s=o.getCursor(),r=o.getLine(s.line),y=o.getOption("indentUnit"),h=r.slice(0,s.ch);if(/^\s*$/.test(h)&&s.ch>0){const F=Math.max(0,s.ch-y);o.setCursor({line:s.line,ch:F})}else o.execCommand("delCharBefore")}});let t=await d("init");if(!t||t.msg!="Success"){g("Alert!","Some error occured while initializing sqlite.");return}if(!c)if((await H("home","getUserModels")).some(r=>r[0]==="Default_DB"))c="Default_DB",b="Default";else{let r=await Q(B);if(r.length>0)c=r[0],b="Default";else{g("Alert!","Model Name not found in the URL.");return}}T();const i=await d("fetchData",c,"SELECT FileName,FileData FROM S_ExecutionFiles WHERE FilePath = ? AND Status = 'Active' ",["requirements.txt"]),n=await d("fetchData",c,"SELECT WheelName,WheelBlob FROM S_PackageWheels");let u=await N("init","editor","",b,c,i,"",[],n),m=document.getElementById("packageIndicator");L(u.stderr),document.getElementById("loadingPackage").classList.add("hidden"),m.classList.remove("spinner-loading"),m.classList.add("spinner-complete"),document.getElementById("downloadZip").onclick=Y,document.getElementById("downloadOutput").onclick=ee,document.getElementById("getText").onclick=$,document.getElementById("uploadZip").onclick=j,document.getElementById("hideCanvas").onclick=z,document.getElementById("addFile").onclick=G,document.getElementById("addFolder").onclick=K,document.getElementById("deleteFile").onclick=X};function x(e){S.setValue(e),setTimeout(function(){S.refresh(),S.focus()},200)}async function $(){A=null,document.getElementById("loadingOverlay").classList.remove("hidden"),document.getElementById("outputTxt").innerHTML="";const e=document.getElementById("myCanvas");let t=S.getValue();const i=await d("fetchData",c,"SELECT FilePath,FileData FROM S_ExecutionFiles WHERE Filename is NOT NULL AND Status = 'Active' ");let l="";f&&(l=f.getAttribute("filepath"),await P());const u=await d("fetchData",c,"SELECT FileName,FileBlob FROM S_DataFiles WHERE FileType = 'Input'"),o=await d("fetchData",c,"SELECT WheelName,WheelBlob FROM S_PackageWheels"),s=await _("Started");let r=await N("execute","editor",t,b,c,i,l,u,o);if(document.getElementById("loadingOverlay").classList.add("hidden"),r.stderr)_("Errored",r.stderr,s);else{_("Completed",null,s);const y=e.getContext("2d");if(y.clearRect(0,0,e.width,e.height),r.blob){A=r.blob;const h=await createImageBitmap(r.blob),F=Math.min(e.width/h.width,e.height/h.height),w=(e.width-h.width*F)/2,D=(e.height-h.height*F)/2;y.drawImage(h,w,D,h.width*F,h.height*F);const q=document.getElementById("canvasDiv");q.style.width!="500px"&&(q.style.width="500px",document.getElementById("mainDiv").style.marginRight="513px")}r.outputFiles&&r.outputFiles.length>0&&(await d("deleteData",c,"DELETE FROM S_DataFiles WHERE FileType = 'Output'"),r.outputFiles.forEach(async([F,w])=>{await d("insertData",c,`INSERT INTO S_DataFiles (FileName,FileType,FileBlob) 
                              VALUES (?, ?, ?) ON CONFLICT (FileName,FileType) DO UPDATE SET FileBlob = ? `,[F,"Output",w,w])}))}L(r.stderr)}function L(e){const t=document.getElementById("outputTxt");if(e){const a=document.createElement("div");a.textContent=`Error: ${e}`,a.style.color="red",t.appendChild(a)}}async function P(){const e=document.getElementById("filesDiv").querySelector("li.selectedValue");if(e){const t=e.getAttribute("filepath"),a=e.innerText,i=S.getValue();if(a==="requirements.txt")try{const n=await N("loadPackages","editor",i);n.stderr&&L(n.stderr)}catch(n){console.error("Error loading packages",n.stderr),L(n.stderr);return}await d("insertData",c,`INSERT INTO S_ExecutionFiles (FileName,FilePath,FileData) VALUES (?, ?, ?) ON CONFLICT (FilePath)
                  DO UPDATE SET FileData = ? `,[a,t,i,i])}}async function j(){const e=document.getElementById("zipFile").files[0];if(e){this.setAttribute("disabled",""),this.innerHTML='<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>',await d("deleteData",c,"DELETE FROM S_ExecutionFiles");const a=new FileReader;a.onload=async function(i){const l=await R.loadAsync(i.target.result),n=[];l.forEach(function(o,s){if(o.includes("__pycache__"))return;const r=s.async("string").then(async function(y){if(y){const h=o.split("/").slice(-1)[0];await d("insertData",c,`INSERT INTO S_ExecutionFiles (FileName,FilePath,FileData) VALUES (?, ?, ?) 
                         ON CONFLICT (FilePath) DO UPDATE SET FileData = ?, FilePath = ?`,[h,o,y,y,o])}});n.push(r)}),await Promise.all(n);const u=document.getElementById("uploadZip");u.removeAttribute("disabled"),u.innerHTML="",u.innerText="Upload",x(""),T(),v.getInstance(document.getElementById("modal-file-upload")).hide(),g("Success","File Uploaded Successfully")},a.readAsArrayBuffer(e)}}function M(e,t=!1,a=null,i=null,l="",n="fa-solid fa-folder"){let u=E("ul","tree");for(let m in e)if(u.appendChild(document.createElement("li")),e[m]&&typeof e[m]=="object"){l+=l?`/${m}`:m;let o=O(m,n);o.setAttribute("folderPath",l),o.onclick=function(r){if(!this.classList.contains("selectedFolder")){for(let y of document.getElementById("filesDiv").querySelectorAll("li.selectedFolder"))y.classList.remove("selectedFolder");for(let y of document.getElementById("filesDiv").querySelectorAll("li.selectedValue"))y.classList.remove("selectedValue");this.classList.add("selectedFolder"),r.preventDefault(),p=this,f=null}};let s=E("ul","childList TreeMembers");s.appendChild(M(e[m],!1,a,i,l)),u.appendChild(o),u.appendChild(s),l=l.replace(/\/[^\/]+$/,"")}else{if(!e[m])continue;let o=O(m,"fa-file-alt",e[m],i,a);o.onclick=async function(s){if(!this.classList.contains("selectedValue")){document.getElementById("outputTxt").innerHTML="",document.getElementById("loadingOverlay").classList.remove("hidden"),await P(),document.getElementById("loadingOverlay").classList.add("hidden");const r=document.getElementById("bottomButtons");r.style.display="";for(let D of document.getElementById("filesDiv").querySelectorAll("li.selectedValue"))D.classList.remove("selectedValue");for(let D of document.getElementById("filesDiv").querySelectorAll("li.selectedFolder"))D.classList.remove("selectedFolder");this.classList.add("selectedValue"),s.preventDefault(),p=null,f=this;const y=this.getAttribute("filepath");y.slice(-4)===".txt"&&(r.style.display="none");const w=await d("fetchData",c,"SELECT FileName,ifnull(FileData,'') FROM S_ExecutionFiles WHERE FilePath = ? AND Status = 'Active' ",[y]);w&&w[0]&&x(w[0][1])}},u.appendChild(o)}return t?E("div","card-body scc-box",null,u):E("div",null,null,u)}function O(e,t,a=null,i=null,l=null){let n=E("li",null,null);i&&l&&a&&e==l&&a==i&&n.classList.add("selectedValue"),n.setAttribute("title",e),a&&n.setAttribute("filepath",a);let u=E("label","checkBox-label",null,E("span",`fas ${t}`));return u.appendChild(document.createTextNode(e)),n.appendChild(u),n}async function T(e=null,t=null){const i=await d("fetchData",c,"SELECT FilePath FROM S_ExecutionFiles"),l={};i.forEach(u=>{const m=u[0].split("/");let o=l;m.forEach((s,r)=>{s&&(r===m.length-1?/^[^\s]+\.(py|txt)$/.test(s)?o[s]=u[0]:o[s]={}:(o[s]=o[s]||{},o=o[s]))})});const n=U(l);document.getElementById("filesDiv").innerHTML="",document.getElementById("filesDiv").appendChild(M(n,!0,e,t))}function U(e){const t={},a=Object.keys(e).filter(l=>typeof e[l]=="object"),i=Object.keys(e).filter(l=>typeof e[l]!="object");if(a.sort().forEach(l=>{t[l]=U(e[l])}),i.sort().forEach(l=>{t[l]=e[l]}),t["requirements.txt"]){const l=t["requirements.txt"];delete t["requirements.txt"],t["requirements.txt"]=l}return t}function z(){const e=document.getElementById("canvasDiv");e.style.width=="500px"&&(e.style.width="0",document.getElementById("mainDiv").style.marginRight="0px")}function Z(){let e=E("div","input-group mb-2"),t=E("input","form-control small-input");return t.type="text",t.addEventListener("keydown",async function(a){if(a.keyCode=="13"){const i=a.target.value;if(a.preventDefault(),/^[^\s]+\.(py|txt)$/.test(i)){let n=i;if(f?n=f.getAttribute("filepath").replace(f.innerText,i):p&&(n=p.getAttribute("folderpath")+`/${i}`),(await d("fetchData",c,"Select FileName FROM S_ExecutionFiles WHERE FileName = ? AND FilePath = ? ",[i,n])).length>0){g("Alert!","Filename Already Exists");return}await d("insertData",c,"INSERT INTO S_ExecutionFiles (FileName,FilePath) VALUES (?, ?) ",[i,n]),I(),await T(i,n);const s=document.getElementById("filesDiv").querySelector("li.selectedValue");if(s){f=s;const r=s.getAttribute("filepath"),h=await d("fetchData",c,"SELECT FileName,ifnull(FileData,'') FROM S_ExecutionFiles WHERE FilePath = ? AND Status = 'Active' ",[r]);h&&h[0]&&x(h[0][1])}}else g("Alert!","Invalid Filename")}}),e.appendChild(t),e}function G(){I();let e=document.querySelector(".tree");f?e=f.parentNode:p&&(e=p.nextElementSibling.querySelector(".tree"));let t=Z();e.insertBefore(t,e.firstChild),t.querySelector("input").focus()}function I(){const e=document.querySelector("div.scc-box").querySelector(".input-group");e&&e.parentNode.removeChild(e)}function J(){let e=E("div","input-group mb-2"),t=E("input","form-control small-input");return t.type="text",t.addEventListener("keydown",async function(a){if(a.keyCode=="13"){const i=a.target.value;if(a.preventDefault(),/^[^\s]+$/.test(i)){let n=i;if(f?n=f.getAttribute("filepath").replace(f.innerText,i):p&&(n=p.getAttribute("folderpath")+`/${i}`),(await d("fetchData",c,"Select FilePath FROM S_ExecutionFiles WHERE FileName IS NULL AND FilePath = ? ",[n])).length>0){g("Alert!","Folder with same name already exists");return}await d("insertData",c,"INSERT INTO S_ExecutionFiles (FilePath) VALUES (?) ",[n]),I(),await T(i,n)}else g("Alert!","Invalid Folder name")}}),e.appendChild(t),e}function K(){I();let e=document.querySelector(".tree");f?e=f.parentNode:p&&(e=p.nextElementSibling.querySelector(".tree"));let t=J();e.insertBefore(t,e.firstChild),t.querySelector("input").focus()}async function X(){if(!f&&!p){g("Alert!","No File Or Folder Selected to delete");return}let e=null;if(f){e=f.getAttribute("filepath"),g("Alert",`Are you sure want to delete '${f.innerText}'`,C.bind(null,e),1);return}else if(p){e=p.getAttribute("folderpath"),g("Alert",`Are you sure you want to permanently delete the '${p.innerText}' folder and all of its contents, including subfolders and files?`,C.bind(null,e),1);return}}async function C(e){await d("deleteData",c,"DELETE FROM S_ExecutionFiles WHERE FilePath Like ? OR FilePath = ?",[`%${e}%`,e]),x(""),f=null,p=null,await T()}async function Y(){try{const t=await d("fetchData",c,"SELECT FilePath,FileData FROM S_ExecutionFiles");if(!t||t.length===0)return;const a=new R;t.forEach(n=>{a.file(n[0],n[1],{binary:!0})});const i=await a.generateAsync({type:"blob"}),l=document.createElement("a");l.href=window.URL.createObjectURL(i),l.download="files.zip",l.click(),setTimeout(function(){window.URL.revokeObjectURL(l.href)},1e3)}catch(e){console.error("Error creating zip file for download:",e)}}async function ee(){const e=document.createElement("a");e.href=window.URL.createObjectURL(A),e.download="output.jpg",e.click(),setTimeout(function(){window.URL.revokeObjectURL(e.href)},1e3)}async function _(e,t=null,a=null){if(f){const i=f.innerText.trim();if(a)await d("updateData",c,`UPDATE T_TaskLogs SET TaskStatus = ?,ErrorMsg = ?, EndDate = datetime('now', 'localtime')
                     WHERE TaskName = ? AND Id = ? `,[e,t,i,a]);else return await d("insertData",c,"INSERT INTO T_TaskLogs (TaskName,TaskStatus,EndDate) VALUES (?, ?, datetime('now', 'localtime'))",[i,e])}}
