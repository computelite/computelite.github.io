import"./pixel.PHV1U_RE.js";import{v as ce,e as p,c as u,A as se,y as J,w as v,x as re,b as d,B as ue,C as me,u as pe,d as ye,D as fe,E as he}from"./scc.BdpBWn71.js";import{M as h}from"./bootstrap.esm.CkDf0L-y.js";import{J as be}from"./jszip.min.C5akSdVy.js";import"https://webr.r-wasm.org/latest/webr.mjs";const A=document.getElementById("scc-one-modal");let q={},O=null,G=null;const Z="1.0.0",Ee=new URLSearchParams(window.location.search),Y=Ee.get("modelUID");let H={};const ne={DB_Icon:"fas fa-database"};let P;function Te(e,t){let o=e.replace(/\s/g,"_"),n=d("div","accordion-item border-light mb-0",null,d("h2","accordion-header",o+"_head",d("button","accordion-button collapsed",null,d("span","h6 mb-0 font-weight-bold",null,document.createTextNode(e)))));n.querySelector("button").setAttribute("type","button"),n.querySelector("button").setAttribute("data-bs-toggle","collapse"),n.querySelector("button").setAttribute("aria-expanded","false"),n.querySelector("button").setAttribute("data-bs-target","#"+o),n.querySelector("button").setAttribute("aria-controls",o);let l=d("div","accordion-collapse collapse",o,d("div","accordion-body",null,d("table","table table-hover",null,d("tbody",null,null,null))));l.setAttribute("aria-labelledby",o+"_head"),l.setAttribute("data-bs-parent","#tableGroup");for(let a of t){let i=d("tr",null,null,d("td",null,null,document.createTextNode(a[1])));i.onclick=function(){const c=document.getElementById("availableModal").querySelector("li.selectedValue");window.open(`./tableDisplay.html?tableName=${a[0]}&modelName=${c.innerText}`)},i.setAttribute("tableName",a[0]),l.querySelector("tbody").appendChild(i)}return n.appendChild(l),n}document.addEventListener("DOMContentLoaded",async function(){H=await ce();let e=await p("init");if(!e||e.msg!="Success"){u("Alert!","Some error occured while initializing sqlite.");return}if(Y){await se("/home/get-attached-model",{modelId:`${Y}`});const n=window.location.origin+window.location.pathname;history.replaceState(null,"",n)}setTimeout(ge,400);const t=document.getElementById("shareBtn");t.classList.add("blink"),document.querySelectorAll(".modal").forEach(n=>{h.getInstance(n)||new h(n)}),document.getElementById("modal-createView").addEventListener("hide.bs.modal",function(){document.getElementById("viewName").value="",document.getElementById("query-input").value=""}),document.getElementById("editorBtn").onclick=async function(){const n=document.getElementById("availableModal").querySelector("li.selectedValue").innerText;if(!n){u("Alert!","Please select a model");return}window.open(`./sqlEditor.html?tableName=V_TEMPV&modelName=${n}`)},document.getElementById("availInpFiles").onclick=function(){document.getElementById("modal-input-files").querySelector("h2").innerText="Input Files",K()},document.getElementById("availOutFiles").onclick=function(){document.getElementById("modal-input-files").querySelector("h2").innerText="Output Files",Le()},document.getElementById("shareBtn").onclick=function(){const n=document.getElementById("availableModal").querySelector("li.selectedValue");if(!n){u("Alert!","Please select a model");return}const l=n.innerText,a=n.getAttribute("project");window.open(`./editorPage.html?projectName=${a}&modelName=${l}`)},document.getElementById("closeOutput").onclick=function(){document.getElementById("outputDiv").style.display="none"},document.getElementById("ok-view").onclick=Be,document.getElementById("deleteModel").onclick=te.bind(null,!0),document.getElementById("removeModel").onclick=te.bind(null,!1),document.getElementById("addNew").onclick=we.bind(null,"Add New Model",!1),document.getElementById("downloadAllFiles").onclick=Re,document.getElementById("addExisting").onclick=Ne,document.getElementById("saveAs").onclick=Se,document.getElementById("uploadModel").onclick=Ie,document.getElementById("downloadModel").onclick=Ae,document.getElementById("uploadExcel").onclick=ve,document.getElementById("downloadExcel").onclick=xe,document.getElementById("vacuum").onclick=Ce,document.getElementById("saveFiles").onclick=Fe,document.getElementById("uploadPackage").onclick=Oe,document.getElementById("downloadOutput").onclick=Pe,await J("init","editor"),t.classList.remove("blink")});async function ge(){document.getElementById("tableGroup").innerHTML="";let e=await v("home","getUserModels");if(e.length==0){let t=await re(H);t.length>0&&e.push(t)}return _e(e),e}function _e(e){let t=document.getElementById("availableModal");t.innerHTML="";for(let o of e)t.appendChild(V(o));Y&&t.lastChild?t.lastChild.click():t.firstChild&&t.firstChild.click()}function V(e){let t=d("li","nav-item mb-0",null,null),o=d("a","nav-link p-2 rounded-0");return o.appendChild(d("span","d-block text-left",null,null)),o.firstChild.appendChild(d("span",`${ne.DB_Icon} pe-2`)),o.firstChild.appendChild(document.createTextNode(e[0])),t.appendChild(o),t.setAttribute("project",e[2]),t.setAttribute("template",e[1]),t.setAttribute("dbtype",e[3]),t.onclick=async function(n){if(t.getAttribute("project"),document.getElementById("outputTxt").innerHTML="",!this.classList.contains("selectedValue")){let c=await v("home","getVersion",{model_name:this.innerText});c!==Z&&await v("home","upgradeVersion",{modelName:this.innerText,db_version:c,current_version:Z});for(let s of this.parentNode.querySelectorAll("li.selectedValue"))s.classList.remove("selectedValue");j(this.innerText,e[1]),this.classList.add("selectedValue"),n.preventDefault()}const l=this.innerText;(await p("fetchData",l,"PRAGMA table_info(S_TaskMaster)")).map(c=>c[1]).includes("TaskType")||await p("executeQuery",l,"ALTER TABLE S_TaskMaster ADD COLUMN TaskType VARCHAR DEFAULT 'PythonScript'"),await p("executeQuery",l,`CREATE TABLE IF NOT EXISTS S_Notebooks (
                NotebookId	    INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
                Name            VARCHAR,
                Type			VARCHAR,
                Status	    	VARCHAR DEFAULT 'Active',
                CreationDate	VARCHAR DEFAULT (datetime('now','localtime')),
                LastUpdateDate	VARCHAR DEFAULT (datetime('now','localtime'))
            )`),await p("executeQuery",l,`CREATE TABLE IF NOT EXISTS S_NotebookContent (
                CellId	        INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
                Name            VARCHAR,
                NotebookId      INTEGER NOT NULL,    
                CellContent	    VARCHAR,
                CellType        VARCHAR,
                CreationDate	VARCHAR DEFAULT (datetime('now','localtime')),
                LastUpdateDate	VARCHAR DEFAULT (datetime('now','localtime'))
            )`),await W(this.innerText)},t}async function j(e,t){document.getElementById("tableGroup").innerHTML="";const o=await v("home","fetchTableGroups",{model_name:e});for(let n in o)document.getElementById("tableGroup").appendChild(Te(n,o[n]))}function ae(e,t="fa-server",o=null){let n=d("ul","tree");for(let l in e){n.appendChild(document.createElement("li"));let a=ee(l,t);n.appendChild(a),a.onclick=function(){let i=a.nextElementSibling;if(a.firstChild.checked){a.firstChild.checked=!1;for(let c of i.childNodes)c.firstChild.checked&&(c.firstChild.checked=!1)}else{a.firstChild.checked=!0;for(let c of i.childNodes)c.firstChild.checked||(c.firstChild.checked=!0)}},n.appendChild(d("ul","childList TreeMembers"));for(let i of e[l]){let c=ee(i[0],ne.DB_Icon);o||(c.onclick=function(s){if(c.firstChild.checked)c.firstChild.checked=!1,a.firstChild.checked&&(a.firstChild.checked=!1);else{c.firstChild.checked=!0,a.firstChild.checked=!0;for(let r of this.parentNode.childNodes)r.firstChild.checked||(a.firstChild.checked=!1)}}),n.lastChild.appendChild(c)}}return d("div","card-body scc-box",null,n)}function ee(e,t){let o=d("li",null,null,d("input","inputcheckbox"));o.firstChild.setAttribute("type","checkbox");let n=d("label","checkBox-label",null,d("span",`fas ${t}`));return n.appendChild(document.createTextNode(e)),o.appendChild(n),o}function x(e,t){const o=A.querySelector(".modal-header h2");o.innerHTML="",o.innerText=e;const n=A.querySelector(".modal-body");n.innerHTML="";const l=A.querySelector(".modal-footer");l.innerHTML="";const a=d("button","btn btn-tertiary",null,document.createTextNode("Cancel"));a.setAttribute("type","button"),a.setAttribute("data-bs-dismiss","modal");const i=d("button","btn btn-primary ml-auto",null,document.createTextNode(t));return i.setAttribute("type","button"),l.appendChild(a),l.appendChild(i),[n,i]}function U(e,t,o,n,l=[],a="",i="",c="text"){let s;const r=d("div","row row-header align-items-center mb-4",e);let m=d("div","col-12 col-sm-4 align-self-center",null,d("label","my-2",null,document.createTextNode(t)));if(s=d("div","col-12 col-sm"),n=="select"){const y=d("select","form-select",o);(l.includes("Default")||l.length==0)&&y.appendChild(d("option",null,null,document.createTextNode("Default")));for(let f of l)if(f!="Default"){let b=d("option",null,null,document.createTextNode(f));y.appendChild(b)}y.firstChild&&(y.firstChild.setAttribute("selected",""),s.appendChild(y))}else{const y=d("div","input-group",null,d("input","form-control",o));y.firstChild.setAttribute("type",c),y.firstChild.setAttribute("placeholder",a),i.trim()!=""&&y.appendChild(d("span","input-group-text",null,d("span",i))),s.appendChild(y)}return r.appendChild(m),r.appendChild(s),r}function we(e,t=!1){const[o,n]=x(e,"Add"),l=d("div","form-group");l.appendChild(U("name_div","Model Name","db_name","normal",[],"","fas fa-database")),t?l.appendChild(U("path_div","Model Path","db_path","normal")):l.appendChild(U("template_div","Model Template","model_template","select",Object.keys(H))),o.appendChild(l),n.onclick=async function(a){const i=document.getElementById("db_name").value;if(i.trim()==""||!oe(i)){u("Alert!","Please enter valid model name");return}for(let b of document.getElementById("availableModal").querySelectorAll("li"))if(i.trim()==b.innerText){u("Alert!",`Model already active with same name ${i}`);return}let c=document.getElementById("model_template"),s="Sample DB";c&&(s=c.value);let r="Default";h.getInstance(A).hide();const f=await v("home","addNewModel",{model_name:i,model_template:s,project_name:r,schemas:H,db_user:"",password:"",host:"",port:0,db_type:"SQLITE"});if(f.msg==="Success"){let b=document.getElementById("availableModal");b.appendChild(V([i,s,r,"SQLITE"])),b.lastChild.click(),u("Success!","New Model added")}else u("Alert!",f.msg)}}async function Ne(){const[e,t]=x("Add Existing Models","Add"),o=new Object,n=await v("home","getExistingModels");let l=new Object;for(let a of n){let i=a[1],c=a[0];o[c]=[i,a[2],a[3]],i in l?l[i].push([c,a[2]]):l[i]=[[c,a[2]]]}e.appendChild(ae(l)),t.onclick=async function(){let a=[];for(let s of document.getElementById("availableModal").querySelectorAll("li"))a.push(s.innerText);let i={},c=[];for(let s of e.querySelectorAll(".TreeMembers li"))if(s.parentNode.classList.contains("childList")&&s.firstChild.checked){if(a.includes(s.innerText)){u("Alert!",`Model Already Active with name ${s.innerText}`);return}let r=s.parentNode.previousElementSibling.innerText;if(r in i||(i[r]=[]),i[r].push(s.innerText),c.includes(s.innerText)){u("Alert!","You Cannot Add more than one model of same name");return}c.push(s.innerText)}if(Object.keys(i).length>0){h.getInstance(A).hide(),await v("home","addExistingModels",{model_list:c,projects_dict:i});let r=document.getElementById("availableModal");for(let m of c)r.appendChild(V([m,o[m][1],o[m][0],o[m][2]]))}else h.getInstance(A).hide()}}function te(e){let t="Hide",o="Hide Models";e&&(t="Delete",o="Delete Models");const[n,l]=x(o,t);let a=new Object;for(let i of document.getElementById("availableModal").childNodes){let c=i.getAttribute("project"),s=i.getAttribute("template"),r=i.innerText;c in a?a[c].push([r,s]):a[c]=[[r,s]]}n.appendChild(ae(a)),l.onclick=async function(){let i=[],c={};for(let s of n.querySelectorAll(".TreeMembers li"))if(s.parentNode.classList.contains("childList")&&s.firstChild.checked){i.push(s.innerText);let r=s.parentNode.previousElementSibling.innerText;r in c||(c[r]=[]),c[r].push(s.innerText)}if(Object.keys(c).length>0){h.getInstance(A).hide(),await v("home","deleteModel",{projects_dict:c,del_opt:e});let r=document.getElementById("availableModal");for(let m of r.querySelectorAll("li"))i.indexOf(m.innerText)>-1&&m.remove();r.firstChild?r.firstChild.click():document.getElementById("tableGroup").innerHTML="",u("Success!","Model removed successfully")}else u("Alert!","Please select atleast one model")}}function Se(e){const t=document.getElementById("availableModal").querySelector("li.selectedValue");if(!t){u("Alert!","Please select a model");return}if(t.getAttribute("dbtype")!="SQLITE"){u("Alert!","Method is applicable only for SQLITE type models");return}else{const o=t.innerText,n=t.getAttribute("project"),l=t.getAttribute("template"),a=t.getAttribute("dbtype"),[i,c]=x("Save As","Save"),s=d("div","form-group mb-4");s.appendChild(U("new_modelName_div","New Model Name","new_model_name","normal",[],"","fas fa-database")),i.appendChild(s),c.onclick=async function(r){const m=document.getElementById("new_model_name").value;if(m.trim()==""||!oe(m)){u("Alert!","Please enter valid model name");return}for(let E of document.getElementById("availableModal").querySelectorAll("li"))if(m.trim()==E.innerText){u("Alert!",`Model already active with same name ${m}`);return}h.getInstance(A).hide();const f=await v("home","saveAsModel",{new_model_name:m,new_model_template:l,project_name:n,model_name:o});if(f.message.indexOf("Invalid")>-1){u("Alert",f.message);return}let b=document.getElementById("availableModal");b.appendChild(V([m,l,n,a])),b.lastChild.click(),u("Success!","Save As Model added")}}}function Ie(e){const t=document.getElementById("availableModal").querySelector("li.selectedValue");if(!t){u("Alert!","Please select a model");return}const o=t.innerText;t.getAttribute("template");const[n,l]=x("Restore Model","Upload"),a=d("input","form-control"),i=d("div","input-group",null,a);a.setAttribute("type","file"),a.setAttribute("accept",".db, .sqlite3"),n.appendChild(i),l.onclick=async function(c){a.files[0]?(l.setAttribute("disabled",""),l.innerHTML='<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>',await ue("home","uploadModel",a.files[0],{model_name:o}),a.value=null,l.removeAttribute("disabled",""),l.innerHTML="Upload",h.getInstance(A).hide(),u("Success!","Model uploaded successfully"),j(o)):u("Alert!","Please choose a model")}}async function Ae(e){let t=document.getElementById("data-loader");const o=document.getElementById("availableModal").querySelector("li.selectedValue");if(!o){u("Alert!","Please select a model");return}const n=o.innerText,l=o.getAttribute("project");t.style.display="",await v("home","downloadModel",{model_name:n,project_name:l}),t.style.display="none"}function ve(e){const t=document.getElementById("availableModal").querySelector("li.selectedValue");if(!t){u("Alert!","Please select a model");return}const o=t.innerText,[n,l]=x("Upload Excel","Upload"),a=d("input","form-control"),i=d("div","input-group",null,a);a.setAttribute("type","file"),a.setAttribute("accept","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"),n.appendChild(i),l.onclick=async function(c){O=a.files[0],O?(l.setAttribute("disabled",""),l.innerHTML='<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>',q={},q=await me(o,[],O),h.getInstance(document.getElementById("scc-one-modal")).hide(),new h(document.getElementById("modal-uploadExcel-info")).show(),a.value=null,l.innerHTML="Upload",l.removeAttribute("disabled","")):u("Alert!","Please choose a file")}}document.getElementById("modal-uploadExcel-info").addEventListener("show.bs.modal",function(){const e=this.querySelector(".modal-body");e.innerHTML="";const t=d("tr"),o=d("div","form-group",null,d("table","table table-bordered table-sm",null,d("thead",null,null,t)));o.style.maxHeight="300px",o.style.overflowY="auto",t.appendChild(d("td","text-center",null,d("h6","m-0",null,document.createTextNode("Sheet Name")))),t.appendChild(d("td","text-center",null,d("h6","m-0",null,document.createTextNode("Upload Option"))));const n=d("tbody");o.firstChild.appendChild(n),e.appendChild(o);for(let l in q){let a=d("tr","");a.appendChild(d("td",null,null,document.createTextNode(l)));const i=d("select","form-select");i.style="line-height:1 !important;";const c=[{value:"purgeAndUpload",text:"Purge and Upload"},{value:"createAndUpload",text:"Drop Table and Upload"},{value:"ignore",text:"Ignore"}],s=[{value:"ignore",text:"Ignore"},{value:"createAndUpload",text:"Create and Upload"}];q[l][0]==="New"?s.forEach(m=>{const y=d("option");y.value=m.value,y.textContent=m.text,i.appendChild(y)}):c.forEach(m=>{const y=document.createElement("option");y.value=m.value,y.textContent=m.text,m.value=="ignore"&&q[l][1]!="Input"&&y.setAttribute("Selected",""),i.appendChild(y)});let r=d("td","text-center",null,i);a.appendChild(r),n.appendChild(a)}});document.getElementById("saveFileName").onclick=async function(){this.setAttribute("disabled",""),this.innerHTML='<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>';const e=document.getElementById("availableModal").querySelector("li.selectedValue"),t=e.innerText;e.getAttribute("template");const o=document.getElementById("modal-uploadExcel-info").querySelector("tbody"),n={};for(let a of o.querySelectorAll("tr")){const i=a.firstElementChild.innerText,c=a.querySelector("select").value;n[i]=c}const l=await pe(t,Object.keys(n),O,n);h.getInstance(document.getElementById("modal-uploadExcel-info")).hide(),u("Success!","Excel uploaded successfully"),ke(l,n),j(t),this.innerText="Upload",this.removeAttribute("disabled")};function ke(e,t){const[o,n]=x("Status","OK"),l=d("tr",null,null,d("td",null,null,document.createTextNode("SheetName"))),a=d("div","form-group mb-4",null,d("table","table table-bordered table-sm",null,d("thead",null,null,l)));a.style.maxHeight="300px",a.style.overflowY="auto",a.style.overflowX="auto",l.appendChild(d("td",null,null,document.createTextNode("Status"))),l.appendChild(d("td",null,null,document.createTextNode("Msg")));const i=d("tbody");a.firstChild.appendChild(i);for(let c in e){let s=d("tr");s.appendChild(d("td",null,null,document.createTextNode(c)));let r,m;!isNaN(e[c])&&t[c]=="createAndUpload"?(r="Create And Uploaded",m=`${e[c]} rows inserted`):isNaN(e[c]&&t[c]=="purgeAndUpload")?(r="Errored",m=e[c]):(r="Purge And Uploaded",m=`${e[c]} rows inserted`),s.appendChild(d("td",null,null,document.createTextNode(r))),s.appendChild(d("td",null,null,document.createTextNode(m))),i.appendChild(s)}o.appendChild(a),new h(document.getElementById("scc-one-modal")).show(),n.onclick=function(){h.getInstance(A).hide()}}function xe(e){const t=document.getElementById("availableModal").querySelector("li.selectedValue");if(!t){u("Alert!","Please select a model");return}const o=[];for(let s of document.getElementById("tableGroup").querySelectorAll("button.accordion-button"))o.push(s.innerText);const n=t.innerText,[l,a]=x("Download Excel","Download"),i=d("input","form-check-input round-check"),c=d("div","form-check",null,i);i.setAttribute("type","checkbox"),i.checked=!0,c.appendChild(d("label","form-check-label",null,document.createTextNode("Input Tables Only")));for(let s of o){let r=c.cloneNode(!0);r.lastChild.innerText=s,l.appendChild(r)}a.onclick=async function(s){let r=[];for(let f of l.querySelectorAll("input:checked"))r.push(f.parentNode.lastChild.innerText);h.getInstance(A).hide();let y=document.getElementById("dl_progress_div");y.querySelector("div").innerText="Downloading",y.style.display="",await ye(n,[],r),y.querySelector("div").innerText="Running",y.style.display="none"}}async function Ce(e){let t=document.getElementById("data-loader");const o=document.getElementById("availableModal").querySelector("li.selectedValue");if(!o){u("Alert!","Please select a model");return}const n=o.innerText;t.style.display="",await p("executeQuery",n,"VACUUM"),t.style.display="none",u("Success!","Model vacuumed successfully")}async function Be(){const e=document.getElementById("viewName").value,t=document.getElementById("query-input").value,o=document.getElementById("availableModal").querySelector("li.selectedValue").innerText;if(!o){u("Alert!","Please select a model");return}(e.trim()==""||t.trim()=="")&&u("Alert!","Please make sure that View Name and Query was entered"),await v("home","checkOrCreateView",{view_name:e,view_query:t,model_name:o,isExist:!1}),h.getInstance(document.getElementById("modal-createView")).hide(),u("Success","View created successfully"),j(o)}function oe(e){var t=/^[a-zA-Z0-9_]+$/;return t.test(e)}function De(e){const t=document.getElementById("outputTxt");if(e){const o=document.createElement("div");o.textContent=`Error: ${e}`,o.style.color="red",t.appendChild(o)}}async function W(e){const t=document.getElementById("taskDiv");t.innerHTML="";const n=await p("fetchData",e,"SELECT TaskId,TaskName,TaskDisplayName,TaskType FROM S_TaskMaster");for(let[l,a,i,c]of n){const s=d("li","d-flex",null),r=d("a","dropdown-item",null,document.createTextNode(i)),m=d("button","btn btn-small edit-btn transparent p-2 me-1",null,d("span","fa-solid fa-pencil")),y=d("button","btn btn-small del-btn transparent p-2 me-1",null,d("span","fa-solid fa-trash-alt"));s.appendChild(r),s.appendChild(m),s.appendChild(y),s.querySelector("button.edit-btn").title="Edit Task",s.querySelector("button.del-btn").title="Delete Task",s.querySelector("button.edit-btn").onclick=async function(f){f.stopPropagation();const b=document.getElementById("upScName");let E=s.innerText.trim();b.innerHTML="";let w=await p("fetchData",e,"SELECT TaskDisplayName, TaskType, TaskName, TaskId FROM S_TaskMaster WHERE TaskDisplayName = ?",[E]);P=w[0][3];let _=w[0][1];if(_=="PythonScript"?_="PScript":_==="PythonNotebook"?_="Python":_==="RNotebook"?_="R":_==="JSNotebook"&&(_="Javascript"),w&&w.length>0){document.getElementById("upDsName").value=w[0][0],document.getElementById("upScType").value=_;let k,R;_==="PScript"?(k="SELECT FileName FROM S_ExecutionFiles WHERE FileName IS NOT NULL AND FileName LIKE '%.py' AND FilePath NOT LIKE '%/%' AND Status = ?",R=await p("fetchData",e,k,["Active"])):(k="SELECT Name FROM S_Notebooks WHERE Status = ? AND Type = ?",R=await p("fetchData",e,k,["Active",_]));for(const M of R){const $=d("option",null,null,document.createTextNode(M));$.setAttribute("value",M),b.appendChild($)}document.getElementById("upScName").value=w[0][2],new h(document.getElementById("modal-updateScript")).show()}},s.querySelector("button.del-btn").onclick=async function(f){f.stopPropagation(),u("Alert!",`Are you sure you want to delete ${i}?`,async function(){let b=c;b==="JavascriptNotebook"&&(b="JSNotebook"),await p("deleteData",e,"DELETE FROM S_TaskMaster WHERE TaskId = ? AND TaskType = ? AND TaskName = ?",[l,b,a]),u("Success","Script Deleted Successfully"),W(e)},1)},s.onclick=async function(){const f=document.getElementById("myCanvas");f.style.display=="none"&&(f.style.display=""),document.getElementById("loadingOverlay").classList.remove("hidden"),document.getElementById("outputDiv").style.display="",document.getElementById("outputTxt").innerHTML="",document.getElementById("downloadOutput").hasAttribute("disabled")&&document.getElementById("downloadOutput").removeAttribute("disabled");const b=document.getElementById("currCell").querySelector(".cell-bottom");b&&b.innerHTML.trim()!==""&&(b.innerHTML=""),G=null;const E=document.getElementById("availableModal").querySelector("li.selectedValue"),D=E.getAttribute("project");let w,_;if(c==="PythonScript")_="SELECT FilePath,FileData,FileName FROM S_ExecutionFiles WHERE FileName IS NOT NULL AND Status = 'Active' ",w=await p("fetchData",E.innerText,_);else{c=="JSNotebook"&&(c="JavascriptNotebook",window.loadCDNScripts=async function(g){const I=(C,F)=>new Promise((B,ie)=>{if(F&&window[F]){B(window[F]);return}const L=document.createElement("script");L.src=C,L.async=!0,L.onload=()=>B(window[F]||!0),L.onerror=()=>ie(new Error(`Failed to load script: ${C}`)),document.head.appendChild(L)});return Promise.all(g.map(C=>I(C.url,C.globalVar)))},window.loadCDNStylesheets=async function(g){return Promise.all(g.map(({url:I})=>new Promise((C,F)=>{const B=document.createElement("link");B.rel="stylesheet",B.href=I,B.onload=()=>C(I),B.onerror=()=>F(`Failed to load CSS: ${I}`),document.head.appendChild(B)})))},window.getData=async(g,I=[])=>p("getData",e,g,I),window.executeQuery=async(g,I=[])=>p("updateData",e,g,I)),_="SELECT Name,CellContent,Name FROM S_NotebookContent WHERE Name = ? AND CellType = ?";const T=await p("fetchData",E.innerText,_,[a,c.replace("Notebook","").toLowerCase()]);let S=[];for(const g of T)S.push(g[1]);w=[[T[0][0],S,T[0][0]]]}let k=null;w.forEach(T=>{T[2]===a&&(k=T[1])});const M=await p("fetchData",E.innerText,"SELECT FileName,FileBlob FROM S_DataFiles WHERE FileType = 'Input'"),z=await p("fetchData",E.innerText,"SELECT WheelName,WheelBlob FROM S_PackageWheels");await p("updateData",E.innerText,"UPDATE S_Taskmaster SET TaskLastRunDate = ? WHERE TaskId = ? ",[Me(),l]);const X=await Q(a,"Started",null,null,l);let N;if(c=="PythonScript"){let T="";for(let S of k)T+=S;N=await J("executeScript","editor",T,D,E.innerText,w,null,M,z)}else if(c=="PythonNotebook")for(let T of k)N=await J("execute","notebook",T,D,E.innerText,w,null,M,z,"currCell");else if(c=="JavascriptNotebook")for(let T of k)N=await fe("currCell",T);else if(c=="RNotebook")for(let T of k)N=await he("currCell",T,E.innerText,M);if(N.stderr)Q(a,"Errored",N.stderr,X);else{if(N.blob){const T=f.getContext("2d");T.clearRect(0,0,f.width,f.height),G=N.blob;const S=await createImageBitmap(N.blob),g=Math.min(f.width/S.width,f.height/S.height),I=(f.width-S.width*g)/2,C=(f.height-S.height*g)/2;T.drawImage(S,I,C,S.width*g,S.height*g),new h(document.getElementById("modal-show-output")).show()}Q(a,"Completed",null,X),N.outputFiles&&N.outputFiles.length>0&&(await p("deleteData",E.innerText,"DELETE FROM S_DataFiles WHERE FileType = 'Output'"),N.outputFiles.forEach(async([S,g])=>{await p("insertData",E.innerText,`INSERT INTO S_DataFiles (FileName,FileType,FileBlob) 
                                            VALUES (?, ?, ?) ON CONFLICT (FileName,FileType) DO UPDATE SET FileBlob = ? `,[S,"Output",g,g])}))}N.success&&c!="PythonScript"&&(new h(document.getElementById("modal-show-output")).show(),f.style.display="none",document.getElementById("downloadOutput").setAttribute("disabled","true")),document.getElementById("loadingOverlay").classList.add("hidden"),De(N.stderr)},t.appendChild(s)}}function Me(){const e=new Date,t=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0"),i=String(e.getSeconds()).padStart(2,"0");return`${t}-${o}-${n} ${l}:${a}:${i}`}async function Q(e,t,o=null,n=null,l=null){const a=document.getElementById("availableModal").querySelector("li.selectedValue");if(n)await p("updateData",a.innerText,`UPDATE T_TaskLogs SET TaskStatus = ?,ErrorMsg = ?, EndDate = datetime('now', 'localtime')
                     WHERE TaskName = ? AND Id = ? `,[t,o,e,n]);else return await p("insertData",a.innerText,"INSERT INTO T_TaskLogs (TaskId,TaskName,TaskStatus,EndDate) VALUES (?, ?, ?, datetime('now', 'localtime'))",[l,e,t])}async function Fe(){this.setAttribute("disabled",""),this.innerHTML='<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>';const e=document.getElementById("availableModal").querySelector("li.selectedValue"),t=document.getElementById("inpFiles");if(t.files.length>0){await p("executeQuery",e.innerText,"DELETE FROM S_DataFiles;",["script"]);for(const n of t.files){const l=await n.arrayBuffer();await p("insertData",e.innerText,`INSERT INTO S_DataFiles (FileName,FileType,FileBlob) 
                            VALUES (?, ?, ?) ON CONFLICT (FileName,FileType) DO UPDATE SET FileBlob = ? `,[n.name,"Input",new Uint8Array(l),new Uint8Array(l)])}this.removeAttribute("disabled",""),this.innerHTML="Upload",h.getInstance(document.getElementById("modal-upload-files")).hide(),u("Success","Files Upload Successfully.")}t.value=null}async function K(){const e=document.getElementById("modal-input-files").querySelector(".modal-body");e.innerHTML="";const t=document.getElementById("availableModal").querySelector("li.selectedValue"),n=await p("fetchData",t.innerText,"SELECT FileId,FileName FROM S_DataFiles WHERE FileType = 'Input' "),l=d("tr"),a=d("div","form-group",null,d("table","table table-bordered table-sm",null,d("thead",null,null,l)));a.style.maxHeight="300px",a.style.overflowY="auto";const i=d("tbody");a.firstChild.appendChild(i),e.appendChild(a);for(let r of n){const m=d("tr","d-flex align-items-center");m.appendChild(d("td","w-100",null,document.createTextNode(r[1])));const y=d("td","input-file-icon m-0 px-2");let f=d("span","fa fa-trash");f.onclick=qe.bind(null,r[1],r[0]),y.appendChild(f);const b=d("td","input-file-icon m-0 px-2");let E=d("span","fa fa-download");E.onclick=de.bind(null,r[1],r[0]),b.appendChild(E);const D=d("td","input-file-icon m-0 px-2");let w=d("span","fa fa-upload");w.onclick=le.bind(null,r[1],r[0]),D.appendChild(w),m.appendChild(y),m.appendChild(D),m.appendChild(b),i.appendChild(m)}const c=d("div","d-flex justify-content-end");let s=d("button","btn btn-primary",null,document.createTextNode("Add File"));c.appendChild(s),e.appendChild(c),s.onclick=le}async function Le(){const e=document.getElementById("modal-input-files").querySelector(".modal-body");e.innerHTML="";const t=document.getElementById("availableModal").querySelector("li.selectedValue"),n=await p("fetchData",t.innerText,"SELECT FileId,FileName FROM S_DataFiles WHERE FileType = 'Output' "),l=d("tr"),a=d("div","form-group",null,d("table","table table-bordered table-sm",null,d("thead",null,null,l)));a.style.maxHeight="300px",a.style.overflowY="auto";const i=d("tbody");a.firstChild.appendChild(i),e.appendChild(a);for(let c of n){const s=d("tr","d-flex align-items-center");s.appendChild(d("td","w-100",null,document.createTextNode(c[1])));const r=d("td","input-file-icon m-0 px-2");let m=d("span","fa fa-download");m.onclick=de.bind(null,c[1],c[0]),r.appendChild(m),s.appendChild(r),i.appendChild(s)}}async function qe(e,t){const o=document.getElementById("availableModal").querySelector("li.selectedValue");await p("deleteData",o.innerText,"DELETE FROM S_DataFiles WHERE FileType = 'Input' AND FileId = ? AND FileName = ? ",[t,e]),K()}async function de(e,t){let o=document.getElementById("modal-input-files").querySelector("h2").innerText.indexOf("Input")>-1?"Input":"Output";const n=document.getElementById("availableModal").querySelector("li.selectedValue"),a=await p("fetchData",n.innerText,"SELECT FileName,FileBlob FROM S_DataFiles WHERE FileType = ? AND FileID = ? AND FileName = ?",[o,t,e]);if(a){const c=new Blob([a[0][1]]);if(window.navigator&&window.navigator.msSaveOrOpenBlob){window.navigator.msSaveOrOpenBlob(c);return}const s=window.URL.createObjectURL(c);var i=document.createElement("a");i.href=s,i.download=e,i.click(),setTimeout(function(){window.URL.revokeObjectURL(s)},1e3)}else u("Alert!","No File Exists")}function le(e=null,t=null){h.getInstance(document.getElementById("modal-input-files")).hide();const o=document.getElementById("availableModal").querySelector("li.selectedValue"),[n,l]=x("Upload Excel","Upload"),a=d("input","form-control"),i=d("div","input-group",null,a);a.setAttribute("type","file"),n.appendChild(i),l.onclick=async function(c){if(a.files[0]){l.setAttribute("disabled",""),l.innerHTML='<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>';const s=await a.files[0].arrayBuffer();e&&t?await p("updateData",o.innerText,"UPDATE S_DataFiles SET FileBlob = ? WHERE FileType = 'Input' AND FileName = ? AND FileId = ? ",[a.files[0].name,new Uint8Array(s),e,t]):await p("insertData",o.innerText,"INSERT INTO S_DataFiles (FileName,FileType,FileBlob) VALUES (?, ?, ?) ON CONFLICT (FileName,FileType) DO UPDATE SET FileBlob = ?",[a.files[0].name,"Input",new Uint8Array(s),new Uint8Array(s)]),h.getInstance(document.getElementById("scc-one-modal")).hide(),new h(document.getElementById("modal-input-files")).show(),a.value=null,l.innerHTML="Upload",l.removeAttribute("disabled",""),K()}else u("Alert!","Please choose a file")},new h(document.getElementById("scc-one-modal")).show()}async function Re(){let e=document.getElementById("modal-input-files").querySelector("h2").innerText.indexOf("Input")>-1?"Input":"Output";const t=document.getElementById("availableModal").querySelector("li.selectedValue");try{const n=await p("fetchData",t.innerText,"SELECT FileName,FileBlob FROM S_DataFiles WHERE FileType = ?",[e]);if(!n||n.length===0){u("Alert!","No files found to download.");return}const l=new be;n.forEach(c=>{l.file(c[0],c[1])});const a=await l.generateAsync({type:"blob"}),i=document.createElement("a");i.href=window.URL.createObjectURL(a),i.download="InputFiles.zip",i.click(),setTimeout(function(){window.URL.revokeObjectURL(i.href)},1e3)}catch(o){console.error("Error creating zip file for download:",o)}}async function Oe(e){const t=document.getElementById("availableModal").querySelector("li.selectedValue");if(!t){u("Alert!","Please select a model");return}const[o,n]=x("Upload Package","Upload"),l=d("input","form-control"),a=d("div","input-group",null,l);l.setAttribute("type","file"),l.setAttribute("accept",".whl"),o.appendChild(a),n.onclick=async function(i){if(l.files[0]){n.setAttribute("disabled",""),n.innerHTML='<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>';const s=await l.files[0].arrayBuffer();try{await p("insertData",t.innerText,"INSERT INTO S_PackageWheels (WheelName,WheelBlob) VALUES (?, ?) ON CONFLICT (WheelName) DO UPDATE SET WheelBlob = ?",[l.files[0].name,new Uint8Array(s),new Uint8Array(s)]),u("Success","Package uploaded successfully!")}catch(r){console.error("Error saving file:",r)}h.getInstance(document.getElementById("scc-one-modal")).hide(),l.value=null,n.innerHTML="Upload",n.removeAttribute("disabled","")}else u("Alert!","Please choose a file")}}async function Pe(){const e=document.createElement("a");e.href=window.URL.createObjectURL(G),e.download="output.jpg",e.click(),setTimeout(function(){window.URL.revokeObjectURL(e.href)},1e3)}document.getElementById("notebookBtn").onclick=function(){const e=document.getElementById("availableModal").querySelector("li.selectedValue");if(!e){u("Alert!","Please select a model");return}const t=e.innerText;window.open(`./PyNotebook.html?modelName=${t}`)};document.getElementById("notebookJS").onclick=function(){const e=document.getElementById("availableModal").querySelector("li.selectedValue");if(!e){u("Alert!","Please select a model");return}const t=e.innerText;window.open(`./JsNotebook.html?modelName=${t}`)};document.getElementById("sqlEditor").onclick=function(){const e=document.getElementById("availableModal").querySelector("li.selectedValue");if(!e){u("Alert!","Please select a model");return}const t=e.innerText;window.open(`./SQLiteStudio/playground/client.html?modelName=${t}`)};document.getElementById("notebookRBtn").onclick=function(){const e=document.getElementById("availableModal").querySelector("li.selectedValue");if(!e){u("Alert!","Please select a model");return}const t=e.innerText;window.open(`./RNotebook.html?modelName=${t}`)};document.getElementById("scType").onchange=async function(){const e=document.getElementById("scType").value,t=document.getElementById("availableModal").querySelector("li.selectedValue"),o=document.getElementById("scName");if(o.innerHTML="",!t){u("Alert!","Please select a model");return}let n,l;e==="PScript"?(n="SELECT FileName FROM S_ExecutionFiles WHERE FileName IS NOT NULL AND FileName LIKE '%.py' AND FilePath NOT LIKE '%/%' AND Status = ?",l=await p("fetchData",t.innerText,n,["Active"])):(n="SELECT Name FROM S_Notebooks WHERE Status = ? AND Type = ?",l=await p("fetchData",t.innerText,n,["Active",e]));for(const a of l){const i=d("option",null,null,document.createTextNode(a));i.setAttribute("value",a),o.appendChild(i)}};document.getElementById("ok-script").onclick=async function(){const e=document.getElementById("dsName").value,t=document.getElementById("scType").value,o=document.getElementById("scName").value,n=document.getElementById("availableModal").querySelector("li.selectedValue");if(e.trim()===""){u("Alert!","Please Enter a display ame");return}if(t==="0"){u("Alert!","Please select a script language");return}if(o==="0"){u("Alert!","Please select a notebook");return}let l;if(t==="Python"?l="PythonNotebook":t==="R"?l="RNotebook":t==="Javascript"?l="JSNotebook":t==="PScript"&&(l="PythonScript"),(await p("fetchData",n.innerText,"SELECT TaskDisplayName FROM S_TaskMaster WHERE TaskDisplayName = ?",[e])).length>0){u("Alert!","Display name already exists");return}if((await p("fetchData",n.innerText,"SELECT TaskName, TaskDisplayName FROM S_TaskMaster WHERE TaskName = ? AND TaskType = ?",[o,l])).length>0){u("Alert!","Script with this name already exists");return}await p("insertData",n.innerText,"INSERT INTO S_TaskMaster (TaskName,TaskDisplayName,TaskType) VALUES (?, ?, ?)",[o,e,l]),await W(n.innerText),h.getInstance(document.getElementById("modal-addScript")).hide(),document.getElementById("dsName").value="",document.getElementById("scType").value="0",document.getElementById("scName").innerHTML="",u("Success","Script created successfully.")};document.getElementById("upScType").onchange=async function(){const e=document.getElementById("upScType").value,t=document.getElementById("availableModal").querySelector("li.selectedValue"),o=document.getElementById("upScName");if(o.innerHTML="",!t){u("Alert!","Please select a model");return}let n,l;e==="PScript"?(n="SELECT FileName FROM S_ExecutionFiles WHERE FileName IS NOT NULL AND FileName LIKE '%.py' AND FilePath NOT LIKE '%/%' AND Status = ?",l=await p("fetchData",t.innerText,n,["Active"])):(n="SELECT Name FROM S_Notebooks WHERE Status = ? AND Type = ?",l=await p("fetchData",t.innerText,n,["Active",e]));for(const a of l){const i=d("option",null,null,document.createTextNode(a));i.setAttribute("value",a),o.appendChild(i)}};document.getElementById("update-script").onclick=async function(){const e=document.getElementById("upDsName").value,t=document.getElementById("upScType").value,o=document.getElementById("upScName").value,n=document.getElementById("availableModal").querySelector("li.selectedValue");if(e.trim()===""){u("Alert!","Please Enter a display ame");return}if(t==="0"){u("Alert!","Please select a script language");return}if(o==="0"){u("Alert!","Please select a notebook");return}let l;if(t==="Python"?l="PythonNotebook":t==="R"?l="RNotebook":t==="Javascript"?l="JSNotebook":t==="PScript"&&(l="PythonScript"),(await p("fetchData",n.innerText,"SELECT TaskDisplayName FROM S_TaskMaster WHERE TaskDisplayName = ? AND TaskId != ?",[e,P])).length>0){u("Alert!","Display name already exists");return}if((await p("fetchData",n.innerText,"SELECT TaskName, TaskDisplayName FROM S_TaskMaster WHERE TaskName = ? AND TaskType = ? AND TaskId != ?",[o,l,P])).length>0){u("Alert!","Script with this name already exists");return}await p("updateData",n.innerText,"UPDATE S_TaskMaster SET TaskName = ?, TaskDisplayName = ?,TaskType = ? WHERE TaskId = ?",[o,e,l,P]),await W(n.innerText),h.getInstance(document.getElementById("modal-updateScript")).hide(),document.getElementById("upDsName").value="",document.getElementById("upScType").value="0",document.getElementById("upScName").innerHTML="",u("Success","Script updated successfully.")};
