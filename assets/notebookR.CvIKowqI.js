import"./pixel.CyAMObzi.js";/* empty css              */import{e as executeQuery,b as get_cl_element,G as consoleNotebookOutput,v as fetchSchema,c as confirmBox$1,w as fetchData,x as addDefaultModel}from"./scc.C0KxU-5h.js";import{r as requireCodemirror,C as CodeMirror}from"./codemirror.i0qkzkfX.js";import{n as nanoid}from"./index.browser.B1VcazSC.js";import{WebR}from"https://webr.r-wasm.org/latest/webr.mjs";(function(t,l){(function(o){o(requireCodemirror())})(function(o){o.registerHelper("wordChars","r",/[\w.]/),o.defineMode("r",function(s){function a(r){for(var i={},c=0;c<r.length;++c)i[r[c]]=!0;return i}var n=["NULL","NA","Inf","NaN","NA_integer_","NA_real_","NA_complex_","NA_character_","TRUE","FALSE"],u=["list","quote","bquote","eval","return","call","parse","deparse"],d=["if","else","repeat","while","function","for","in","next","break"],f=["if","else","repeat","while","function","for"];o.registerHelper("hintWords","r",n.concat(u,d));var m=a(n),y=a(u),h=a(d),b=a(f),g=/[+\-*\/^<>=!&|~$:]/,w;function N(r,i){w=null;var c=r.next();if(c=="#")return r.skipToEnd(),"comment";if(c=="0"&&r.eat("x"))return r.eatWhile(/[\da-f]/i),"number";if(c=="."&&r.eat(/\d/))return r.match(/\d*(?:e[+\-]?\d+)?/),"number";if(/\d/.test(c))return r.match(/\d*(?:\.\d+)?(?:e[+\-]\d+)?L?/),"number";if(c=="'"||c=='"')return i.tokenize=k(c),"string";if(c=="`")return r.match(/[^`]+`/),"variable-3";if(c=="."&&r.match(/.(?:[.]|\d+)/))return"keyword";if(/[a-zA-Z\.]/.test(c)){r.eatWhile(/[\w\.]/);var p=r.current();return m.propertyIsEnumerable(p)?"atom":h.propertyIsEnumerable(p)?(b.propertyIsEnumerable(p)&&!r.match(/\s*if(\s+|$)/,!1)&&(w="block"),"keyword"):y.propertyIsEnumerable(p)?"builtin":"variable"}else return c=="%"?(r.skipTo("%")&&r.next(),"operator variable-2"):c=="<"&&r.eat("-")||c=="<"&&r.match("<-")||c=="-"&&r.match(/>>?/)?"operator arrow":c=="="&&i.ctx.argList?"arg-is":g.test(c)?c=="$"?"operator dollar":(r.eatWhile(g),"operator"):/[\(\){}\[\];]/.test(c)?(w=c,c==";"?"semi":null):null}function k(r){return function(i,c){if(i.eat("\\")){var p=i.next();return p=="x"?i.match(/^[a-f0-9]{2}/i):(p=="u"||p=="U")&&i.eat("{")&&i.skipTo("}")?i.next():p=="u"?i.match(/^[a-f0-9]{4}/i):p=="U"?i.match(/^[a-f0-9]{8}/i):/[0-7]/.test(p)&&i.match(/^[0-7]{1,2}/),"string-2"}else{for(var C;(C=i.next())!=null;){if(C==r){c.tokenize=N;break}if(C=="\\"){i.backUp(1);break}}return"string"}}}var v=1,_=2,S=4;function E(r,i,c){r.ctx={type:i,indent:r.indent,flags:0,column:c.column(),prev:r.ctx}}function D(r,i){var c=r.ctx;r.ctx={type:c.type,indent:c.indent,flags:c.flags|i,column:c.column,prev:c.prev}}function x(r){r.indent=r.ctx.indent,r.ctx=r.ctx.prev}return{startState:function(){return{tokenize:N,ctx:{type:"top",indent:-s.indentUnit,flags:_},indent:0,afterIdent:!1}},token:function(r,i){if(r.sol()&&(i.ctx.flags&3||(i.ctx.flags|=_),i.ctx.flags&S&&x(i),i.indent=r.indentation()),r.eatSpace())return null;var c=i.tokenize(r,i);return c!="comment"&&!(i.ctx.flags&_)&&D(i,v),(w==";"||w=="{"||w=="}")&&i.ctx.type=="block"&&x(i),w=="{"?E(i,"}",r):w=="("?(E(i,")",r),i.afterIdent&&(i.ctx.argList=!0)):w=="["?E(i,"]",r):w=="block"?E(i,"block",r):w==i.ctx.type?x(i):i.ctx.type=="block"&&c!="comment"&&D(i,S),i.afterIdent=c=="variable"||c=="keyword",c},indent:function(r,i){if(r.tokenize!=N)return 0;var c=i&&i.charAt(0),p=r.ctx,C=c==p.type;return p.flags&S&&(p=p.prev),p.type=="block"?p.indent+(c=="{"?0:s.indentUnit):p.flags&v?p.column+(C?0:1):p.indent+(C?0:s.indentUnit)},lineComment:"#"}}),o.defineMIME("text/x-rsrc","r")})})();let canvas=null;function createCodeMirrorEditor(t,l,o,s,a,n=[]){const u=document.getElementById(t);var d=CodeMirror(u.querySelector("div.computelite-text-editor"),{mode:"r",lineNumbers:!0,lineWrapping:!0,tabSize:4,indentUnit:4,smartIndent:!0,matchBrackets:!0,autoCloseBrackets:!0,autofocus:!0,extraKeys:{"Ctrl-/":"toggleComment","Ctrl-Enter":async f=>executeCode(d,u,l,o,a,n),"Shift-Enter":async f=>runAndMoveToNextCell(d,u,l,o,a,n)}});return d.addKeyMap({Backspace:function(f){const m=f.getCursor(),y=f.getLine(m.line),h=f.getOption("indentUnit"),b=y.slice(0,m.ch);if(/^\s*$/.test(b)&&m.ch>0){const g=Math.max(0,m.ch-h);f.setCursor({line:m.line,ch:g})}else f.execCommand("delCharBefore")}}),u.querySelector("button.cell-controls-button").onclick=function(){executeCode(d,u,l,o,a,n)},setTimeout(()=>{d.refresh(),s&&d.setValue(s)},10),d}async function runAndMoveToNextCell(t,l,o,s,a,n){var f;await executeCode(t,l,o,s,a,n);const u=document.querySelectorAll("computelite-cell");if(u[u.length-1]===l){const m=document.getElementById("jsListDiv").querySelector("li.selectedValue"),y=m.getAttribute("id");if(!o){confirmBox("Alert!","Model Name not found in the URL.");return}try{const h=await executeQuery("insertData",o,"INSERT INTO S_NotebookContent (CellContent, Name, NotebookId, CellType) VALUES (?, ?, ?, ?)",["",m.innerText,y,"r"]),b=createCodeEditor(h,y,n);setTimeout(()=>{var N;const g=document.querySelectorAll(".computelite-cell .CodeMirror"),w=g[g.length-1];(N=w==null?void 0:w.CodeMirror)==null||N.focus()},50)}catch(h){console.error("Failed to add new cell:",h)}}else for(let m=0;m<u.length-1;m++)if(u[m]===l){const y=u[m+1].querySelector(".CodeMirror");(f=y==null?void 0:y.CodeMirror)==null||f.focus();break}}async function initializeWebR(t){(!window.webr||window.webr.terminated)&&(window.webr=new WebR,await window.webr.init(),await setupFileSystem(),await writeInputFiles(t))}async function executeCode(editor,cell,modelName,CellId,notebookId,blobFiles){editor.getInputField().blur();const query=editor.getValue();cell.querySelector(".cell-bottom").innerHTML="",cell.querySelector(".sidebar-inner")&&(cell.querySelector(".sidebar-inner").innerHTML="");const btn=cell.querySelector("span.fa-regular");btn!=null&&btn.classList.contains("fa-play-circle")&&btn.classList.replace("fa-play-circle","fa-hourglass");const updateQuery="UPDATE S_NotebookContent SET CellContent = ? WHERE CellId = ? AND lower(CellType) = ? AND NotebookId = ?";await executeQuery("updateData",modelName,updateQuery,[query,CellId,"r",notebookId]);const htmlOutput=get_cl_element("div");cell.querySelector(".cell-bottom").appendChild(htmlOutput);try{await initializeWebR(blobFiles);const requiredPackages=extractRequiredPackages(query);await installMissingPackages(requiredPackages);const fsModelPath=`/home/web_user/data/${modelName}.sqlite3`;await loadSQLiteFromOPFS(fsModelPath,modelName,"Default"),await window.webr.evalR(`thisDB <- "${fsModelPath}"`);const shelter=await new window.webr.Shelter,result=await shelter.captureR(query);shelter.purge();const updatedFile=await window.webr.FS.readFile(fsModelPath);if(await saveSQLiteToOPFS(modelName,"Default",updatedFile),btn!=null&&btn.classList.contains("fa-hourglass")&&btn.classList.replace("fa-hourglass","fa-play-circle"),result!==void 0){let output=result.output;if(output.length>0)for(const item of output)if(item.type=="stdout")if(isHTML(item.data)){let val=await convertResult("html",item.data);htmlOutput.appendChild(val),val.querySelectorAll('script[type|="text/javascript"]').forEach(e=>{e.textContent!==null&&eval(e.textContent)})}else consoleROutput(cell,item.data);else item.type=="stderr"?consoleNotebookOutput(cell,[`Execution Error: ${item.data}`],"error"):consoleROutput(cell,item.data);if(result.images.length>0){const t=result.images[0];canvas=document.createElement("canvas"),canvas.width=t.width,canvas.height=t.height,canvas.style.width="100%",canvas.style.height="auto",canvas.getContext("2d").drawImage(t,0,0),htmlOutput.appendChild(canvas)}const outputFiles=await readDir("/home/web_user/outputDir");outputFiles.length>0&&await saveOutputFiles(modelName,outputFiles)}}catch(t){btn!=null&&btn.classList.contains("fa-hourglass")&&btn.classList.replace("fa-hourglass","fa-play-circle"),t.message.includes("Syntax error")?consoleNotebookOutput(cell,[`Syntax Error: ${t.message}`],"error"):consoleNotebookOutput(cell,[`Execution Error: ${t.message}`],"error")}}function isHTML(t){const l=new DOMParser().parseFromString(t,"text/html");return Array.from(l.body.childNodes).some(o=>o.nodeType===1)}async function convertResult(t,l){{let o=get_cl_element("div","rendered_html cell-output-html");return o.appendChild(new DOMParser().parseFromString(l,"text/html").body.firstChild),o}}function consoleROutput(t,l){let o=t.querySelector("div.sidebar-inner");if(!o){const s=get_cl_element("computelite-output",null,null,get_cl_element("div","sidebar-inner px-4 py-2"));t.querySelector(".cell-bottom").appendChild(s),o=t.querySelector("div.sidebar-inner")}if(l){const s=document.createElement("div");s.textContent=l,s.style.whiteSpace="pre",o.appendChild(s)}}function extractRequiredPackages(t){const l=/library\(["']?([\w\.]+)["']?\)/g,o=/require\(["']?([\w\.]+)["']?\)/g,s=/([\w\.]+)::[\w\.]+/g;let a=new Set,n;for(;(n=l.exec(t))!==null;)a.add(n[1]);for(;(n=o.exec(t))!==null;)a.add(n[1]);for(;(n=s.exec(t))!==null;)a.add(n[1]);return Array.from(a)}async function installMissingPackages(t){var o;let l=[];for(const s of t){const a=`if (!requireNamespace("${s}", quietly = TRUE)) { cat("${s}") }`,n=await new window.webr.Shelter,u=await n.captureR(a);n.purge(),((o=u==null?void 0:u.output)==null?void 0:o.length)>0&&l.push(s)}if(l.length>0){console.log("Installing missing packages:",l);const s=`
            webr::shim_install()
            install.packages(c(${l.map(n=>`"${n}"`).join(", ")}))
        `,a=await new window.webr.Shelter;await a.captureR(s),a.purge()}}async function loadSQLiteFromOPFS(t,l,o){const f=await(await(await(await(await(await navigator.storage.getDirectory()).getDirectoryHandle("data",{create:!0})).getDirectoryHandle(o,{create:!1})).getFileHandle(`${l}.sqlite3`)).getFile()).arrayBuffer(),m=new Uint8Array(f);window.webr.FS.writeFile(t,m)}async function saveSQLiteToOPFS(t,l,o){const d=await(await(await(await(await navigator.storage.getDirectory()).getDirectoryHandle("data",{create:!0})).getDirectoryHandle(l,{create:!1})).getFileHandle(`${t}.sqlite3`,{create:!1})).createWritable();await d.write(o),await d.close()}async function setupFileSystem(){const t="/home/web_user/inputDir",l="/home/web_user/outputDir",o="/home/web_user/data";await window.webr.evalR('inputDir <- "/home/web_user/inputDir"'),await window.webr.evalR('outputDir <- "/home/web_user/outputDir"'),await window.webr.FS.mkdir(t),await window.webr.FS.mkdir(l),await window.webr.FS.mkdir(o)}async function writeInputFiles(t){for(let l of t)await window.webr.FS.writeFile(`inputDir/${l[0]}`,l[1])}async function readDir(t){let l=[];try{const o=await window.webr.FS.lookupPath(t);for(const s in o.contents){const a=`${t}/${s}`;if(!(await window.webr.FS.lookupPath(a)).isFolder){const u=await window.webr.FS.readFile(a),d=await new Blob([u]).arrayBuffer(),f=new Uint8Array(d);l.push([s,f])}}}catch{console.error("Some error occured while reading output file")}return l}async function saveOutputFiles(t,l){await executeQuery("deleteData",t,"DELETE FROM S_DataFiles WHERE FileType = 'Output'"),l.forEach(async([s,a])=>{await executeQuery("insertData",t,`INSERT INTO S_DataFiles (FileName,FileType,FileBlob) 
                            VALUES (?, ?, ?) ON CONFLICT (FileName,FileType) DO UPDATE SET FileBlob = ? `,[s,"Output",a,a])})}const params=new URLSearchParams(window.location.search);let modelName=params.get("modelName"),schema={},blobFiles=[];const container=document.getElementById("cellContainer");window.onload=async function(){schema=await fetchSchema();let t=await executeQuery("init");if(!t||t.msg!="Success"){confirmBox$1("Alert!","Some error occured while initializing sqlite.");return}else if(!modelName)if((await fetchData("home","getUserModels")).some(n=>n[0]==="Default_DB"))modelName="Default_DB";else{let n=await addDefaultModel(schema);if(n.length>0)modelName=n[0];else{confirmBox$1("Alert!","Model Name not found in the URL.");return}}blobFiles=await executeQuery("fetchData",modelName,"SELECT FileName,FileBlob FROM S_DataFiles WHERE FileType = 'Input'"),await fetchNotebookName();let o=document.getElementById("jsListDiv").querySelector("li.selectedValue");await populateCells(o.innerText,blobFiles)};async function populateCells(t,l){try{(await executeQuery("fetchData",modelName,"SELECT CellId,CellContent,NotebookId FROM S_NotebookContent WHERE Name = ? AND CellType = ?",[t,"r"])).forEach(([a,n,u])=>createCodeEditor(a,u,l,n))}catch(o){console.error("Error populating cells:",o)}}function createCodeEditor(t,l,o,s=""){const a=nanoid(),n=get_cl_element("computelite-cell","cell-grid cell-container celltype-r",a);n.setAttribute("tabindex","0");const u=get_cl_element("div","cell-controls cell-controls-left cell-controls-left-top"),d=get_cl_element("button","btn cell-controls-button py-1");d.title="Run Cell";const f=get_cl_element("span","fa-regular fa-play-circle");f.style.fontSize="16px",d.appendChild(f),u.appendChild(d);const m=get_cl_element("div","cell-top flush");let y=get_cl_element("div");y.style="position: relative;width: 100%;height: 0;";const h=get_cl_element("div","computelite-text-editor-controls",null,get_cl_element("div"));h.firstChild.appendChild(get_cl_element("button","btn btn-small transparent p-1 px-1 me-1",null,get_cl_element("span","fa-solid fa-trash-alt"))),h.querySelector("button").title="Delete Cell",h.querySelector("span").style="color: #00000066;",h.querySelector("button").onclick=async function(){await executeQuery("deleteData",modelName,"DELETE FROM S_NotebookContent WHERE CellId = ? AND CellType = ? AND NotebookId = ?",[t,"r",l])&&n.remove()};const b=get_cl_element("computelite-text-editor"),g=get_cl_element("div","computelite-text-editor");y.appendChild(h),b.appendChild(y),b.appendChild(g),m.appendChild(b),n.appendChild(u),n.appendChild(m);const w=get_cl_element("div","cell-bottom");n.appendChild(w),container.appendChild(n),createCodeMirrorEditor(a,modelName,t,s,l,o)}document.getElementById("addCell").onclick=async function(){let t=document.getElementById("jsListDiv").querySelector("li.selectedValue"),l=t.getAttribute("id");if(!modelName){confirmBox$1("Alert!","Model Name not found in the URL.");return}try{const s=await executeQuery("insertData",modelName,"INSERT INTO S_NotebookContent (CellContent, Name, NotebookId, CellType) VALUES (?, ?, ?, ?)",["",t.innerText,l,"r"]);createCodeEditor(s,l,blobFiles)}catch(o){console.error("Error adding cell:",o)}};async function fetchNotebookName(){try{let t=document.getElementById("jsListDiv"),o=await executeQuery("fetchData",modelName,"SELECT Name, NotebookId FROM S_Notebooks WHERE Status = 'Active' AND Type = 'R'"),s=new Set;if(o.length>0){for(let a of o)if(a[0]&&!s.has(a[0])){s.add(a[0]);let n=get_cl_element("li","py-0 ps-1",a[1],null),u=get_cl_element("label","checkBox-label",null,get_cl_element("span","fas fa-file-alt"),null);u.appendChild(document.createTextNode(a[0])),n.appendChild(u),t.appendChild(n),n.onclick=async function(d){for(let f of document.getElementById("jsListDiv").querySelectorAll("li.selectedValue"))f.classList.remove("selectedValue");this.classList.add("selectedValue"),container.innerHTML="",await populateCells(this.innerText)}}t.firstElementChild.classList.add("selectedValue")}else{let n=await executeQuery("insertData",modelName,"INSERT INTO S_Notebooks (Name,Type,Status) VALUES (?, ?, ?) RETURNING NotebookId",["Default","R","Active"]);await executeQuery("insertData",modelName,"INSERT INTO S_NotebookContent (Name,CellContent,CellType,NotebookId) VALUES (?, ?, ?, ?)",["Default","","r",n]);let d=get_cl_element("li","py-0 ps-1",n,null),f=get_cl_element("label","checkBox-label",null,get_cl_element("span","fas fa-file-alt"),null);f.appendChild(document.createTextNode("Default")),d.appendChild(f),t.appendChild(d),d.classList.add("selectedValue"),container.innerHTML="",d.onclick=async function(m){for(let y of t.querySelectorAll("li.selectedValue"))y.classList.remove("selectedValue");this.classList.add("selectedValue"),container.innerHTML="",await populateCells(this.innerText)}}}catch(t){confirmBox$1("Alert!",`Error during execution:, ${t}`),console.error("Error during execution:",t);return}}document.getElementById("addNotebook").onclick=async function(){document.getElementById("inputDiv").classList.remove("d-none"),document.getElementById("notebookName").focus()};document.getElementById("notebookName").onkeydown=async function(t){try{if(t.key==="Enter"){t.preventDefault();const l=t.target.value.trim();if(l===""){confirmBox$1("Alert!","Please enter Notebook Name.");return}if(!/^[^\s]+$/.test(l)){confirmBox$1("Alert!","Please enter a valid Notebook Name.");return}if((await executeQuery("fetchData",modelName,"SELECT name FROM S_Notebooks WHERE name = ? AND Type = 'R'",[l])).length>0){confirmBox$1("Alert!","Notebook Name Already Exists");return}let u=await executeQuery("insertData",modelName,"INSERT INTO S_Notebooks (Name,Type,Status) VALUES (?, ?, ?) RETURNING NotebookId",[l,"R","Active"]);await executeQuery("insertData",modelName,"INSERT INTO S_NotebookContent (CellContent, Name, NotebookId, CellType) VALUES (?, ?, ?, ?)",["",l,u,"r"]),document.getElementById("inputDiv").classList.add("d-none");let f=document.getElementById("jsListDiv"),m=get_cl_element("li","py-0 ps-1",u,null),y=get_cl_element("label","checkBox-label",null,get_cl_element("span","fas fa-file-alt"),null);y.appendChild(document.createTextNode(l)),m.appendChild(y),f.appendChild(m);for(let h of f.querySelectorAll("li.selectedValue"))h.classList.remove("selectedValue");m.classList.add("selectedValue"),container.innerHTML="",await populateCells(l),t.target.value="",m.onclick=async function(h){for(let b of f.querySelectorAll("li.selectedValue"))b.classList.remove("selectedValue");this.classList.add("selectedValue"),container.innerHTML="",await populateCells(this.innerText)}}}catch(l){console.error("Error adding notebook:",l)}};document.getElementById("deleteNotebook").onclick=function(){let t=document.getElementById("jsListDiv").querySelector("li.selectedValue");t?confirmBox$1("",`Are You Sure Want to Delete ${t.innerText}`,deleteNoteBookLi.bind(null,t),1):confirmBox$1("Alert!","No Notebook Selected to delete")};async function deleteNoteBookLi(t){let l=t.getAttribute("id");await executeQuery("deleteData",modelName,"DELETE FROM S_Notebooks WHERE NotebookId = ? AND Type = 'R'",[l]);const a=await executeQuery("deleteData",modelName,"DELETE FROM S_NotebookContent WHERE NotebookId = ? AND CellType = 'r'",[l]);for(let u of document.querySelectorAll("computelite-cell"))a&&u.remove();document.getElementById("jsListDiv").innerHTML="",await fetchNotebookName();let n=document.getElementById("jsListDiv").querySelector("li.selectedValue");await populateCells(n.innerText)}document.getElementById("toggleSidebar").onclick=function(){document.getElementById("sidebarMenu").classList.toggle("contracted"),container.classList.toggle("cell-position"),document.getElementById("inputDiv").classList.add("d-none")};
