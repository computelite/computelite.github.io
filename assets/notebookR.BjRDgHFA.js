import"./pixel.PHV1U_RE.js";/* empty css              */import{e as executeQuery,b as get_cl_element,G as consoleNotebookOutput,v as fetchSchema,c as confirmBox,w as fetchData,x as addDefaultModel}from"./scc.BdpBWn71.js";import{r as requireCodemirror,C as CodeMirror}from"./codemirror.BeiFTLV5.js";import{WebR}from"https://webr.r-wasm.org/latest/webr.mjs";import{n as nanoid}from"./index.browser.vcSNLBTf.js";(function(t,l){(function(n){n(requireCodemirror())})(function(n){n.registerHelper("wordChars","r",/[\w.]/),n.defineMode("r",function(s){function c(o){for(var i={},a=0;a<o.length;++a)i[o[a]]=!0;return i}var r=["NULL","NA","Inf","NaN","NA_integer_","NA_real_","NA_complex_","NA_character_","TRUE","FALSE"],u=["list","quote","bquote","eval","return","call","parse","deparse"],d=["if","else","repeat","while","function","for","in","next","break"],f=["if","else","repeat","while","function","for"];n.registerHelper("hintWords","r",r.concat(u,d));var p=c(r),w=c(u),b=c(d),h=c(f),g=/[+\-*\/^<>=!&|~$:]/,y;function E(o,i){y=null;var a=o.next();if(a=="#")return o.skipToEnd(),"comment";if(a=="0"&&o.eat("x"))return o.eatWhile(/[\da-f]/i),"number";if(a=="."&&o.eat(/\d/))return o.match(/\d*(?:e[+\-]?\d+)?/),"number";if(/\d/.test(a))return o.match(/\d*(?:\.\d+)?(?:e[+\-]\d+)?L?/),"number";if(a=="'"||a=='"')return i.tokenize=C(a),"string";if(a=="`")return o.match(/[^`]+`/),"variable-3";if(a=="."&&o.match(/.(?:[.]|\d+)/))return"keyword";if(/[a-zA-Z\.]/.test(a)){o.eatWhile(/[\w\.]/);var m=o.current();return p.propertyIsEnumerable(m)?"atom":b.propertyIsEnumerable(m)?(h.propertyIsEnumerable(m)&&!o.match(/\s*if(\s+|$)/,!1)&&(y="block"),"keyword"):w.propertyIsEnumerable(m)?"builtin":"variable"}else return a=="%"?(o.skipTo("%")&&o.next(),"operator variable-2"):a=="<"&&o.eat("-")||a=="<"&&o.match("<-")||a=="-"&&o.match(/>>?/)?"operator arrow":a=="="&&i.ctx.argList?"arg-is":g.test(a)?a=="$"?"operator dollar":(o.eatWhile(g),"operator"):/[\(\){}\[\];]/.test(a)?(y=a,a==";"?"semi":null):null}function C(o){return function(i,a){if(i.eat("\\")){var m=i.next();return m=="x"?i.match(/^[a-f0-9]{2}/i):(m=="u"||m=="U")&&i.eat("{")&&i.skipTo("}")?i.next():m=="u"?i.match(/^[a-f0-9]{4}/i):m=="U"?i.match(/^[a-f0-9]{8}/i):/[0-7]/.test(m)&&i.match(/^[0-7]{1,2}/),"string-2"}else{for(var N;(N=i.next())!=null;){if(N==o){a.tokenize=E;break}if(N=="\\"){i.backUp(1);break}}return"string"}}}var v=1,x=2,k=4;function _(o,i,a){o.ctx={type:i,indent:o.indent,flags:0,column:a.column(),prev:o.ctx}}function D(o,i){var a=o.ctx;o.ctx={type:a.type,indent:a.indent,flags:a.flags|i,column:a.column,prev:a.prev}}function S(o){o.indent=o.ctx.indent,o.ctx=o.ctx.prev}return{startState:function(){return{tokenize:E,ctx:{type:"top",indent:-s.indentUnit,flags:x},indent:0,afterIdent:!1}},token:function(o,i){if(o.sol()&&(i.ctx.flags&3||(i.ctx.flags|=x),i.ctx.flags&k&&S(i),i.indent=o.indentation()),o.eatSpace())return null;var a=i.tokenize(o,i);return a!="comment"&&!(i.ctx.flags&x)&&D(i,v),(y==";"||y=="{"||y=="}")&&i.ctx.type=="block"&&S(i),y=="{"?_(i,"}",o):y=="("?(_(i,")",o),i.afterIdent&&(i.ctx.argList=!0)):y=="["?_(i,"]",o):y=="block"?_(i,"block",o):y==i.ctx.type?S(i):i.ctx.type=="block"&&a!="comment"&&D(i,k),i.afterIdent=a=="variable"||a=="keyword",a},indent:function(o,i){if(o.tokenize!=E)return 0;var a=i&&i.charAt(0),m=o.ctx,N=a==m.type;return m.flags&k&&(m=m.prev),m.type=="block"?m.indent+(a=="{"?0:s.indentUnit):m.flags&v?m.column+(N?0:1):m.indent+(N?0:s.indentUnit)},lineComment:"#"}}),n.defineMIME("text/x-rsrc","r")})})();let canvas=null;function createCodeMirrorEditor(t,l,n,s,c,r=[]){const u=document.getElementById(t);var d=CodeMirror(u.querySelector("div.computelite-text-editor"),{lineNumbers:!0,lineWrapping:!0,mode:"r",autoRefresh:!0,autofocus:!0,tabSize:4,indentUnit:4,extraKeys:{"Ctrl-Enter":async f=>executeCode(d,u,l,n,c,r)}});return d.addKeyMap({Backspace:function(f){const p=f.getCursor(),w=f.getLine(p.line),b=f.getOption("indentUnit"),h=w.slice(0,p.ch);if(/^\s*$/.test(h)&&p.ch>0){const g=Math.max(0,p.ch-b);f.setCursor({line:p.line,ch:g})}else f.execCommand("delCharBefore")}}),u.querySelector("button.cell-controls-button").onclick=function(){executeCode(d,u,l,n,c,r)},setTimeout(()=>{d.refresh(),s&&d.setValue(s)},10),d}async function initializeWebR(t){(!window.webr||window.webr.terminated)&&(window.webr=new WebR,await window.webr.init(),await setupFileSystem(),await writeInputFiles(t))}async function executeCode(editor,cell,modelName,CellId,notebookId,blobFiles){editor.getInputField().blur();const query=editor.getValue();cell.querySelector(".cell-bottom").innerHTML="",cell.querySelector(".sidebar-inner")&&(cell.querySelector(".sidebar-inner").innerHTML="");const btn=cell.querySelector("span.fa-regular");btn!=null&&btn.classList.contains("fa-play-circle")&&btn.classList.replace("fa-play-circle","fa-hourglass");const updateQuery="UPDATE S_NotebookContent SET CellContent = ? WHERE CellId = ? AND lower(CellType) = ? AND NotebookId = ?";await executeQuery("updateData",modelName,updateQuery,[query,CellId,"r",notebookId]);const htmlOutput=get_cl_element("div");cell.querySelector(".cell-bottom").appendChild(htmlOutput);try{await initializeWebR(blobFiles);const requiredPackages=extractRequiredPackages(query);await installMissingPackages(requiredPackages);const fsModelPath=`/home/web_user/data/${modelName}.sqlite3`;await loadSQLiteFromOPFS(fsModelPath,modelName,"Default"),await window.webr.evalR(`thisDB <- "${fsModelPath}"`);const shelter=await new window.webr.Shelter,result=await shelter.captureR(query);shelter.purge();const updatedFile=await window.webr.FS.readFile(fsModelPath);if(await saveSQLiteToOPFS(modelName,"Default",updatedFile),btn!=null&&btn.classList.contains("fa-hourglass")&&btn.classList.replace("fa-hourglass","fa-play-circle"),result!==void 0){let output=result.output;if(output.length>0)for(const item of output)if(item.type=="stdout")if(isHTML(item.data)){let val=await convertResult("html",item.data);htmlOutput.appendChild(val),val.querySelectorAll('script[type|="text/javascript"]').forEach(e=>{e.textContent!==null&&eval(e.textContent)})}else consoleROutput(cell,item.data);else item.type=="stderr"?consoleNotebookOutput(cell,[`Execution Error: ${item.data}`],"error"):consoleROutput(cell,item.data);if(result.images.length>0){const t=result.images[0];canvas=document.createElement("canvas"),canvas.width=t.width,canvas.height=t.height,canvas.style.width="100%",canvas.style.height="auto",canvas.getContext("2d").drawImage(t,0,0),htmlOutput.appendChild(canvas)}const outputFiles=await readDir("/home/web_user/outputDir");outputFiles.length>0&&await saveOutputFiles(modelName,outputFiles)}}catch(t){btn!=null&&btn.classList.contains("fa-hourglass")&&btn.classList.replace("fa-hourglass","fa-play-circle"),t.message.includes("Syntax error")?consoleNotebookOutput(cell,[`Syntax Error: ${t.message}`],"error"):consoleNotebookOutput(cell,[`Execution Error: ${t.message}`],"error")}}function isHTML(t){const l=new DOMParser().parseFromString(t,"text/html");return Array.from(l.body.childNodes).some(n=>n.nodeType===1)}async function convertResult(t,l){{let n=get_cl_element("div","rendered_html cell-output-html");return n.appendChild(new DOMParser().parseFromString(l,"text/html").body.firstChild),n}}function consoleROutput(t,l){let n=t.querySelector("div.sidebar-inner");if(!n){const s=get_cl_element("computelite-output",null,null,get_cl_element("div","sidebar-inner px-4 py-2"));t.querySelector(".cell-bottom").appendChild(s),n=t.querySelector("div.sidebar-inner")}if(l){const s=document.createElement("div");s.textContent=l,s.style.whiteSpace="pre",n.appendChild(s)}}function extractRequiredPackages(t){const l=/library\(["']?([\w\.]+)["']?\)/g,n=/require\(["']?([\w\.]+)["']?\)/g,s=/([\w\.]+)::[\w\.]+/g;let c=new Set,r;for(;(r=l.exec(t))!==null;)c.add(r[1]);for(;(r=n.exec(t))!==null;)c.add(r[1]);for(;(r=s.exec(t))!==null;)c.add(r[1]);return Array.from(c)}async function installMissingPackages(t){var n;let l=[];for(const s of t){const c=`if (!requireNamespace("${s}", quietly = TRUE)) { cat("${s}") }`,r=await new window.webr.Shelter,u=await r.captureR(c);r.purge(),((n=u==null?void 0:u.output)==null?void 0:n.length)>0&&l.push(s)}if(l.length>0){console.log("Installing missing packages:",l);const s=`
            webr::shim_install()
            install.packages(c(${l.map(r=>`"${r}"`).join(", ")}))
        `,c=await new window.webr.Shelter;await c.captureR(s),c.purge()}}async function loadSQLiteFromOPFS(t,l,n){const f=await(await(await(await(await(await navigator.storage.getDirectory()).getDirectoryHandle("data",{create:!0})).getDirectoryHandle(n,{create:!1})).getFileHandle(`${l}.sqlite3`)).getFile()).arrayBuffer(),p=new Uint8Array(f);window.webr.FS.writeFile(t,p)}async function saveSQLiteToOPFS(t,l,n){const d=await(await(await(await(await navigator.storage.getDirectory()).getDirectoryHandle("data",{create:!0})).getDirectoryHandle(l,{create:!1})).getFileHandle(`${t}.sqlite3`,{create:!1})).createWritable();await d.write(n),await d.close()}async function setupFileSystem(){const t="/home/web_user/inputDir",l="/home/web_user/outputDir",n="/home/web_user/data";await window.webr.evalR('inputDir <- "/home/web_user/inputDir"'),await window.webr.evalR('outputDir <- "/home/web_user/outputDir"'),await window.webr.FS.mkdir(t),await window.webr.FS.mkdir(l),await window.webr.FS.mkdir(n)}async function writeInputFiles(t){for(let l of t)await window.webr.FS.writeFile(`inputDir/${l[0]}`,l[1])}async function readDir(t){let l=[];try{const n=await window.webr.FS.lookupPath(t);for(const s in n.contents){const c=`${t}/${s}`;if(!(await window.webr.FS.lookupPath(c)).isFolder){const u=await window.webr.FS.readFile(c),d=await new Blob([u]).arrayBuffer(),f=new Uint8Array(d);l.push([s,f])}}}catch{console.error("Some error occured while reading output file")}return l}async function saveOutputFiles(t,l){await executeQuery("deleteData",t,"DELETE FROM S_DataFiles WHERE FileType = 'Output'"),l.forEach(async([s,c])=>{await executeQuery("insertData",t,`INSERT INTO S_DataFiles (FileName,FileType,FileBlob) 
                            VALUES (?, ?, ?) ON CONFLICT (FileName,FileType) DO UPDATE SET FileBlob = ? `,[s,"Output",c,c])})}const params=new URLSearchParams(window.location.search);let modelName=params.get("modelName"),schema={},blobFiles=[];const container=document.getElementById("cellContainer");window.onload=async function(){schema=await fetchSchema();let t=await executeQuery("init");if(!t||t.msg!="Success"){confirmBox("Alert!","Some error occured while initializing sqlite.");return}else if(!modelName)if((await fetchData("home","getUserModels")).some(r=>r[0]==="Default_DB"))modelName="Default_DB";else{let r=await addDefaultModel(schema);if(r.length>0)modelName=r[0];else{confirmBox("Alert!","Model Name not found in the URL.");return}}blobFiles=await executeQuery("fetchData",modelName,"SELECT FileName,FileBlob FROM S_DataFiles WHERE FileType = 'Input'"),await fetchNotebookName();let n=document.getElementById("jsListDiv").querySelector("li.selectedValue");await populateCells(n.innerText,blobFiles)};async function populateCells(t,l){try{(await executeQuery("fetchData",modelName,"SELECT CellId,CellContent,NotebookId FROM S_NotebookContent WHERE Name = ? AND CellType = ?",[t,"r"])).forEach(([c,r,u])=>createCodeEditor(c,u,l,r))}catch(n){console.error("Error populating cells:",n)}}function createCodeEditor(t,l,n,s=""){const c=nanoid(),r=get_cl_element("computelite-cell","cell-grid cell-container celltype-r",c);r.setAttribute("tabindex","0");const u=get_cl_element("div","cell-controls cell-controls-left cell-controls-left-top"),d=get_cl_element("button","btn cell-controls-button py-1");d.title="Run Cell";const f=get_cl_element("span","fa-regular fa-play-circle");f.style.fontSize="16px",d.appendChild(f),u.appendChild(d);const p=get_cl_element("div","cell-top flush");let w=get_cl_element("div");w.style="position: relative;width: 100%;height: 0;";const b=get_cl_element("div","computelite-text-editor-controls",null,get_cl_element("div"));b.firstChild.appendChild(get_cl_element("button","btn btn-small transparent p-1 px-1 me-1",null,get_cl_element("span","fa-solid fa-trash-alt"))),b.querySelector("button").title="Delete Cell",b.querySelector("span").style="color: #00000066;",b.querySelector("button").onclick=async function(){await executeQuery("deleteData",modelName,"DELETE FROM S_NotebookContent WHERE CellId = ? AND CellType = ? AND NotebookId = ?",[t,"r",l])&&r.remove()};const h=get_cl_element("computelite-text-editor"),g=get_cl_element("div","computelite-text-editor");w.appendChild(b),h.appendChild(w),h.appendChild(g),p.appendChild(h),r.appendChild(u),r.appendChild(p);const y=get_cl_element("div","cell-bottom");r.appendChild(y),container.appendChild(r),createCodeMirrorEditor(c,modelName,t,s,l,n)}document.getElementById("addCell").onclick=async function(){let t=document.getElementById("jsListDiv").querySelector("li.selectedValue"),l=t.getAttribute("id");if(!modelName){confirmBox("Alert!","Model Name not found in the URL.");return}try{const s=await executeQuery("insertData",modelName,"INSERT INTO S_NotebookContent (CellContent, Name, NotebookId, CellType) VALUES (?, ?, ?, ?)",["",t.innerText,l,"r"]);createCodeEditor(s,l,blobFiles)}catch(n){console.error("Error adding cell:",n)}};async function fetchNotebookName(){try{let t=document.getElementById("jsListDiv"),n=await executeQuery("fetchData",modelName,"SELECT Name, NotebookId FROM S_Notebooks WHERE Status = 'Active' AND Type = 'R'"),s=new Set;if(n.length>0){for(let c of n)if(c[0]&&!s.has(c[0])){s.add(c[0]);let r=get_cl_element("li","py-0 ps-1",c[1],null),u=get_cl_element("label","checkBox-label",null,get_cl_element("span","fas fa-file-alt"),null);u.appendChild(document.createTextNode(c[0])),r.appendChild(u),t.appendChild(r),r.onclick=async function(d){for(let f of document.getElementById("jsListDiv").querySelectorAll("li.selectedValue"))f.classList.remove("selectedValue");this.classList.add("selectedValue"),container.innerHTML="",await populateCells(this.innerText)}}t.firstElementChild.classList.add("selectedValue")}else{let r=await executeQuery("insertData",modelName,"INSERT INTO S_Notebooks (Name,Type,Status) VALUES (?, ?, ?) RETURNING NotebookId",["Default","R","Active"]);await executeQuery("insertData",modelName,"INSERT INTO S_NotebookContent (Name,CellContent,CellType,NotebookId) VALUES (?, ?, ?, ?)",["Default","","r",r]);let d=get_cl_element("li","py-0 ps-1",r,null),f=get_cl_element("label","checkBox-label",null,get_cl_element("span","fas fa-file-alt"),null);f.appendChild(document.createTextNode("Default")),d.appendChild(f),t.appendChild(d),d.classList.add("selectedValue"),container.innerHTML="",d.onclick=async function(p){for(let w of t.querySelectorAll("li.selectedValue"))w.classList.remove("selectedValue");this.classList.add("selectedValue"),container.innerHTML="",await populateCells(this.innerText)}}}catch(t){confirmBox("Alert!",`Error during execution:, ${t}`),console.error("Error during execution:",t);return}}document.getElementById("addNotebook").onclick=async function(){document.getElementById("inputDiv").classList.remove("d-none"),document.getElementById("notebookName").focus()};document.getElementById("notebookName").onkeydown=async function(t){try{if(t.key==="Enter"){t.preventDefault();const l=t.target.value.trim();if(l===""){confirmBox("Alert!","Please enter Notebook Name.");return}if(!/^[^\s]+$/.test(l)){confirmBox("Alert!","Please enter a valid Notebook Name.");return}if((await executeQuery("fetchData",modelName,"SELECT name FROM S_Notebooks WHERE name = ? AND Type = 'R'",[l])).length>0){confirmBox("Alert!","Notebook Name Already Exists");return}let u=await executeQuery("insertData",modelName,"INSERT INTO S_Notebooks (Name,Type,Status) VALUES (?, ?, ?) RETURNING NotebookId",[l,"R","Active"]);await executeQuery("insertData",modelName,"INSERT INTO S_NotebookContent (CellContent, Name, NotebookId, CellType) VALUES (?, ?, ?, ?)",["",l,u,"r"]),document.getElementById("inputDiv").classList.add("d-none");let f=document.getElementById("jsListDiv"),p=get_cl_element("li","py-0 ps-1",u,null),w=get_cl_element("label","checkBox-label",null,get_cl_element("span","fas fa-file-alt"),null);w.appendChild(document.createTextNode(l)),p.appendChild(w),f.appendChild(p);for(let b of f.querySelectorAll("li.selectedValue"))b.classList.remove("selectedValue");p.classList.add("selectedValue"),container.innerHTML="",await populateCells(l),t.target.value="",p.onclick=async function(b){for(let h of f.querySelectorAll("li.selectedValue"))h.classList.remove("selectedValue");this.classList.add("selectedValue"),container.innerHTML="",await populateCells(this.innerText)}}}catch(l){console.error("Error adding notebook:",l)}};document.getElementById("deleteNotebook").onclick=function(){let t=document.getElementById("jsListDiv").querySelector("li.selectedValue");t?confirmBox("",`Are You Sure Want to Delete ${t.innerText}`,deleteNoteBookLi.bind(null,t),1):confirmBox("Alert!","No Notebook Selected to delete")};async function deleteNoteBookLi(t){let l=t.getAttribute("id");await executeQuery("deleteData",modelName,"DELETE FROM S_Notebooks WHERE NotebookId = ? AND Type = 'R'",[l]);const c=await executeQuery("deleteData",modelName,"DELETE FROM S_NotebookContent WHERE NotebookId = ? AND CellType = 'r'",[l]);for(let u of document.querySelectorAll("computelite-cell"))c&&u.remove();document.getElementById("jsListDiv").innerHTML="",await fetchNotebookName();let r=document.getElementById("jsListDiv").querySelector("li.selectedValue");await populateCells(r.innerText)}document.getElementById("toggleSidebar").onclick=function(){document.getElementById("sidebarMenu").classList.toggle("contracted"),container.classList.toggle("cell-position"),document.getElementById("inputDiv").classList.add("d-none")};
